<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Note Link v0.9.1（縦折りたたみ・ページ移動分離・背景単色）</title>
  <style>
    :root{ --bg:#0b1220; --panel:#111827; --ink:#e5e7eb; --muted:#374151; --accent:#50C878; }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{ margin:0; background:var(--bg); color:var(--ink);
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic","Meiryo",sans-serif;
      overflow:hidden; background-image:none!important; }
    header{ height:48px; display:flex; align-items:center; justify-content:space-between; gap:8px; padding:0 12px; background:var(--panel); border-bottom:1px solid var(--muted); }
    header .brand{ display:flex; gap:8px; align-items:center; font-weight:700; }
    header .brand .dot{ width:10px; height:10px; border-radius:50%; background:var(--accent); box-shadow:0 0 10px var(--accent); }
    header .ver{ font-size:12px; padding:2px 8px; border:1px solid var(--muted); border-radius:10px; opacity:.85; }
    header .actions{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .pager{ display:flex; gap:6px; align-items:center; background:#0b1220; border:1px solid var(--muted); border-radius:12px; padding:4px 8px; }
    .pager .count{ min-width:64px; text-align:center; font-variant-numeric:tabular-nums; }

    button, input[type="color"], select{ background:#0b1220; color:var(--ink); border:1px solid var(--muted); border-radius:10px; padding:8px 10px; height:34px; }
    button{ cursor:pointer; }
    button:hover{ border-color:var(--accent); }
    button.active{ outline:2px solid var(--accent); }

    .wrap{ display:grid; grid-template-columns:56px 1fr; height:calc(100% - 48px); transition:grid-template-columns .2s ease; }
    .wrap.collapsedX{ grid-template-columns:44px 1fr; }
    .sidebar{ position:relative; background:var(--panel); border-right:1px solid var(--muted); padding:8px; display:flex; flex-direction:column; gap:8px; overflow:auto; }
    .sidebar.collapsedY{ max-height:44px; overflow:hidden; }
    .sidebar .toggleBar{ position:absolute; top:8px; right:-10px; width:22px; height:22px; border-radius:50%; background:#0b1220; border:1px solid var(--muted); display:grid; place-items:center; font-size:12px; cursor:pointer; }
    .toolGroup{ display:flex; flex-direction:column; align-items:center; gap:4px; }
    .tool{ width:40px; height:40px; border-radius:12px; display:grid; place-items:center; border:1px solid var(--muted); background:#0b1220; }
    .tool.active{ border-color:var(--accent); }
    .gear{ width:26px; height:26px; border-radius:8px; display:none; place-items:center; border:1px solid var(--muted); font-size:12px; opacity:.85; }
    .toolGroup.active .gear{ display:grid; }
    .tool-label{ font-size:10px; opacity:.8; }

    .stage{ position:relative; background:#0b1220; background-image:none!important; }
    canvas{ display:block; width:100%; height:100%; background:transparent; }

    .flyout{ position:absolute; top:72px; left:72px; width:360px; max-width:90vw; max-height:70vh; overflow:auto; background:rgba(17,24,39,.98); border:1px solid var(--muted); border-radius:14px; box-shadow:0 10px 32px rgba(0,0,0,.45); padding:10px; backdrop-filter:blur(6px); }
    .flyout.hidden{ display:none; }
    .tabbar{ display:flex; gap:6px; margin-bottom:6px; flex-wrap:wrap; }
    .tabbar button{ height:30px; padding:4px 8px; border-radius:8px; }

    .row{ display:flex; gap:8px; align-items:center; margin-bottom:8px; flex-wrap:wrap; }
    .row input[type="range"]{ width:160px; }
    .swatch{ width:22px; height:22px; border-radius:6px; border:1px solid #64748b; cursor:pointer; }
    .swatchRow{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

    .textInput{ position:absolute; background:#fff; color:#111827; border:1px solid #94a3b8; border-radius:6px; padding:4px 6px; min-width:120px; outline:none; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
</head>
<body>
  <header>
    <div class="brand"><span class="dot"></span> Note Link v0.9.1 <span class="ver">v0.9.1</span></div>
    <div class="actions">
      <button id="btnUndo" title="元に戻す (Ctrl+Z)">↶</button>
      <button id="btnRedo" title="やり直す (Ctrl+Y)">↷</button>
      <div class="pager">
        <button id="btnPrevPage">◀</button>
        <span id="pageCount" class="count">1 / 1</span>
        <button id="btnNextPage">▶</button>
        <button id="btnAddPage">＋</button>
        <button id="btnDelPage">－</button>
      </div>
      <button id="btnExportPng">PNG出力</button>
      <button id="btnSaveDoc">保存</button>
      <button id="btnLoadDoc">読込</button>
      <input type="file" id="fileLoad" accept="application/json" style="display:none">
      <input type="file" id="fileBg" accept="image/*" style="display:none">
      <button id="btnSetBg">背景</button>
      <input type="file" id="filePdf" accept="application/pdf" style="display:none">
      <button id="btnSetPdf">PDF</button>
    </div>
  </header>

  <div class="wrap" id="wrap">
    <aside class="sidebar" id="sidebar">
      <div class="toggleBar" id="toggleBar" title="ツールバーを縦に折りたたむ/戻す">△</div>
      <div class="toolGroup" id="groupPen">
        <button class="tool active" id="toolPen" title="ペン">✎</button>
        <button class="gear" id="gearPen" title="ペン設定">⚙</button>
        <div class="tool-label">ペン</div>
      </div>
      <div class="toolGroup" id="groupHL">
        <button class="tool" id="toolHL" title="蛍光ペン">🖍</button>
        <button class="gear" id="gearHL" title="蛍光ペン設定">⚙</button>
        <div class="tool-label">蛍光</div>
      </div>
      <div class="toolGroup" id="groupEraser">
        <button class="tool" id="toolEraser" title="消しゴム">⌫</button>
        <button class="gear" id="gearEraser" title="消しゴム設定">⚙</button>
        <div class="tool-label">消</div>
      </div>
      <div class="toolGroup" id="groupPan">
        <button class="tool" id="toolPan" title="移動">🖐</button>
        <button class="gear" id="gearPan" title="移動設定">⚙</button>
        <div class="tool-label">移動</div>
      </div>
      <div class="toolGroup" id="groupText">
        <button class="tool" id="toolText" title="テキスト">⌨</button>
        <button class="gear" id="gearText" title="テキスト設定">⚙</button>
        <div class="tool-label">テキスト</div>
      </div>
      <div class="toolGroup" id="groupGuide">
        <button class="tool" id="toolGuide" title="罫線">📏</button>
        <button class="gear" id="gearGuide" title="罫線設定">⚙</button>
        <div class="tool-label">ガイド</div>
      </div>
      <div class="toolGroup" id="groupBg">
        <button class="tool" id="toolBg" title="背景色">🎨</button>
        <button class="gear" id="gearBg" title="背景色設定">⚙</button>
        <div class="tool-label">背景</div>
      </div>
    </aside>

    <main class="stage" id="stage">
      <canvas id="canvas"></canvas>

      <div class="flyout hidden" id="flyout">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px;">
          <div id="flyoutTitle" style="font-weight:700;">設定</div>
          <div style="display:flex;gap:6px;align-items:center;">
            <span class="dragHandle">⠿</span>
            <button class="gear" id="flyoutClose" style="display:grid;place-items:center;">✕</button>
          </div>
        </div>
        <div class="tabbar" id="tabbar"></div>
        <div id="flyoutBody"></div>
      </div>

      <input class="textInput" id="textInput" style="display:none">
    </main>
  </div>

  <!-- Templates -->
  <template id="tmpl-pen"><div>
    <div class="row"><label>色</label><input type="color" id="color" value="#fffae6"></div>
    <div class="row"><label>太さ</label><input type="range" id="size" min="1" max="30" value="3"><span id="sizeVal">3</span></div>
    <div class="row"><label>不透明度</label><input type="range" id="alpha" min="0.05" max="1" step="0.05" value="1"><span id="alphaVal">1</span></div>
    <div class="row"><label><input type="checkbox" id="pressure" checked> 筆圧（疑似）</label></div>
  </div></template>

  <template id="tmpl-hl"><div>
    <div class="row"><label>色</label><input type="color" id="hlColor" value="#ffff66"></div>
    <div class="row"><label>太さ</label><input type="range" id="hlSize" min="4" max="60" value="16"><span id="hlSizeVal">16</span></div>
  </div></template>

  <template id="tmpl-eraser"><div>
    <div class="row"><label>消去範囲</label><input type="range" id="eraserRadius" min="8" max="48" value="16"><span id="eraserRadiusVal">16</span></div>
  </div></template>

  <template id="tmpl-bg"><div>
    <div class="row"><strong>色：</strong></div>
    <div class="row swatchRow">
      <div class="swatch" data-c="#0b1220" style="background:#0b1220" title="黒"></div>
      <div class="swatch" data-c="#ffffff" style="background:#ffffff" title="白"></div>
      <div class="swatch" data-c="#e0f7ff" style="background:#e0f7ff" title="淡青"></div>
      <div class="swatch" data-c="#e0ffe7" style="background:#e0ffe7" title="淡緑"></div>
      <div class="swatch" data-c="#fffce0" style="background:#fffce0" title="淡黄"></div>
      <div class="swatch" data-c="#ffe0ef" style="background:#ffe0ef" title="淡ピンク"></div>
    </div>
    <div class="row"><label>カスタム</label><input type="color" id="bgPicker" value="#0b1220"></div>
  </div></template>

  <template id="tmpl-text"><div>
    <div class="row"><label>色</label><input type="color" id="textColor" value="#ffffff"></div>
    <div class="row"><label>文字サイズ</label><input type="range" id="textSize" min="10" max="72" value="18"><span id="textSizeVal">18</span></div>
  </div></template>

  <template id="tmpl-guide"><div>
    <div class="row"><label for="guideType">種類</label>
      <select id="guideType">
        <option value="none">なし</option>
        <option value="ruled">横罫（A/B/C/U/UL）</option>
        <option value="grid">方眼</option>
        <option value="dot">ドット方眼</option>
        <option value="eng">英習罫</option>
      </select></div>
    <div class="row"><label>間隔(px)</label><input type="range" id="guideSpacing" min="8" max="100" value="28"><span id="guideSpacingVal">28</span></div>
    <div class="row"><label>左マージン(px)</label><input type="range" id="guideMargin" min="0" max="240" value="40"><span id="guideMarginVal">40</span></div>
    <div class="row"><label>不透明度</label><input type="range" id="guideOpacity" min="0.05" max="1" step="0.05" value="0.25"><span id="guideOpacityVal">0.25</span></div>
  </div></template>

  <script>
  console.log('Note Link v0.9.1 ready');
  const state = {
    pages:[{strokes:[],texts:[],bg:null,bgBitmap:null,bgSize:{w:0,h:0}}],
    pageIndex:0,
    tool:'pen',
    bgColor:'#0b1220',
    pen:{color:'#fffae6', size:3, alpha:1, pressure:true},
    hl:{color:'#ffff66', size:16, alpha:.35},
    eraser:{radius:16},
    guide:{type:'none', spacing:28, marginLeft:40, opacity:.25},
    view:{scale:1,x:0,y:0,min:.2,max:6},
    drawing:false, stroke:null, pointerId:null
  };

  const wrap = document.getElementById('wrap');
  const sidebar = document.getElementById('sidebar');
  const toggleBar = document.getElementById('toggleBar');
  toggleBar.onclick = ()=>{
    sidebar.classList.toggle('collapsedY');
    wrap.classList.toggle('collapsedX');
    toggleBar.textContent = sidebar.classList.contains('collapsedY') ? '▽' : '△';
    resizeCanvas();
  };

  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const stage = document.getElementById('stage');
  const dpr = Math.max(1, window.devicePixelRatio||1);
  function resizeCanvas(){
    const r = stage.getBoundingClientRect();
    canvas.width = Math.floor(r.width*dpr);
    canvas.height = Math.floor(r.height*dpr);
    ctx.setTransform(1,0,0,1,0,0); ctx.scale(dpr,dpr);
    render();
  }
  window.addEventListener('resize', resizeCanvas);

  function page(){ return state.pages[state.pageIndex]; }

  // tools
  const toolIds = { pen:'toolPen', hl:'toolHL', eraser:'toolEraser', pan:'toolPan', text:'toolText', guide:'toolGuide', bg:'toolBg' };
  function setTool(t){
    state.tool = t;
    Object.values(toolIds).forEach(id=>document.getElementById(id).classList.remove('active'));
    document.getElementById(toolIds[t]).classList.add('active');
  }
  document.getElementById('toolPen').onclick = ()=> setTool('pen');
  document.getElementById('toolHL').onclick = ()=> setTool('hl');
  document.getElementById('toolEraser').onclick = ()=> setTool('eraser');
  document.getElementById('toolPan').onclick = ()=> setTool('pan');
  document.getElementById('toolText').onclick = ()=> setTool('text');
  document.getElementById('toolGuide').onclick = ()=> openGear('guide');
  document.getElementById('toolBg').onclick = ()=> openGear('bg');

  // gear
  const flyout = document.getElementById('flyout');
  const flyoutBody = document.getElementById('flyoutBody');
  const flyoutTitle = document.getElementById('flyoutTitle');
  document.getElementById('flyoutClose').onclick = ()=> flyout.classList.add('hidden');
  function openGear(kind){
    flyout.classList.remove('hidden');
    flyoutTitle.textContent = ({ pen:'ペン設定', hl:'蛍光ペン設定', eraser:'消しゴム設定', bg:'背景色', guide:'罫線', text:'テキスト' }[kind]) || '設定';
    const tmpl = document.getElementById('tmpl-'+(kind==='hl'?'hl':kind));
    flyoutBody.innerHTML=''; flyoutBody.appendChild(tmpl.content.cloneNode(true));
    bindGear(kind);
  }
  function bindGear(kind){
    if(kind==='pen'){
      const c = flyoutBody.querySelector('#color');
      const s = flyoutBody.querySelector('#size'); const sv=flyoutBody.querySelector('#sizeVal');
      const a = flyoutBody.querySelector('#alpha'); const av=flyoutBody.querySelector('#alphaVal');
      const p = flyoutBody.querySelector('#pressure');
      c.value = state.pen.color; s.value = state.pen.size; sv.textContent=s.value; a.value=state.pen.alpha; av.textContent=a.value; p.checked=state.pen.pressure;
      c.oninput=()=> state.pen.color=c.value;
      s.oninput=()=>{ state.pen.size=+s.value; sv.textContent=s.value; };
      a.oninput=()=>{ state.pen.alpha=+a.value; av.textContent=a.value; };
      p.onchange=()=> state.pen.pressure=p.checked;
    }
    if(kind==='hl'){
      const c = flyoutBody.querySelector('#hlColor');
      const s = flyoutBody.querySelector('#hlSize'); const sv = flyoutBody.querySelector('#hlSizeVal');
      c.value = state.hl.color; s.value = state.hl.size; sv.textContent=s.value;
      c.oninput=()=> state.hl.color=c.value;
      s.oninput=()=>{ state.hl.size=+s.value; sv.textContent=s.value; };
    }
    if(kind==='eraser'){
      const r = flyoutBody.querySelector('#eraserRadius'); const rv=flyoutBody.querySelector('#eraserRadiusVal');
      r.value = state.eraser.radius; rv.textContent=r.value;
      r.oninput=()=>{ state.eraser.radius=+r.value; rv.textContent=r.value; };
    }
    if(kind==='bg'){
      const picker = flyoutBody.querySelector('#bgPicker'); picker.value = state.bgColor;
      picker.oninput = ()=>{ state.bgColor = picker.value; render(); };
      flyoutBody.querySelectorAll('.swatch').forEach(el=>{
        el.onclick = ()=>{ state.bgColor = el.getAttribute('data-c'); picker.value = state.bgColor; render(); };
      });
    }
    if(kind==='guide'){
      const type = flyoutBody.querySelector('#guideType');
      const sp = flyoutBody.querySelector('#guideSpacing'); const spv = flyoutBody.querySelector('#guideSpacingVal');
      const mg = flyoutBody.querySelector('#guideMargin'); const mgv = flyoutBody.querySelector('#guideMarginVal');
      const op = flyoutBody.querySelector('#guideOpacity'); const opv = flyoutBody.querySelector('#guideOpacityVal');
      type.value = state.guide.type; sp.value=state.guide.spacing; spv.textContent=sp.value; mg.value=state.guide.marginLeft; mgv.textContent=mg.value; op.value=state.guide.opacity; opv.textContent=op.value;
      type.onchange=()=>{ state.guide.type=type.value; render(); };
      sp.oninput=()=>{ state.guide.spacing=+sp.value; spv.textContent=sp.value; render(); };
      mg.oninput=()=>{ state.guide.marginLeft=+mg.value; mgv.textContent=mg.value; render(); };
      op.oninput=()=>{ state.guide.opacity=+op.value; opv.textContent=op.value; render(); };
    }
  }

  // header actions
  const pageCount = document.getElementById('pageCount');
  function updatePageCount(){ pageCount.textContent = `${state.pageIndex+1} / ${state.pages.length}`; }
  document.getElementById('btnPrevPage').onclick = ()=>{ if(state.pageIndex>0){ state.pageIndex--; updatePageCount(); render(); } };
  document.getElementById('btnNextPage').onclick = ()=>{ if(state.pageIndex < state.pages.length-1){ state.pageIndex++; updatePageCount(); render(); } };
  document.getElementById('btnAddPage').onclick = ()=>{ state.pages.splice(state.pageIndex+1,0,{strokes:[],texts:[],bg:null,bgBitmap:null,bgSize:{w:0,h:0}}); state.pageIndex++; updatePageCount(); render(); };
  document.getElementById('btnDelPage').onclick = ()=>{ if(state.pages.length===1){ alert('これ以上削除できません'); return; } state.pages.splice(state.pageIndex,1); state.pageIndex=Math.max(0,state.pageIndex-1); updatePageCount(); render(); };

  // save/load/png
  document.getElementById('btnSaveDoc').onclick = ()=>{
    const snap = JSON.stringify({pages:state.pages.map(p=>({strokes:p.strokes,texts:p.texts,bg:p.bg,bgSize:p.bgSize})), pageIndex:state.pageIndex, bgColor:state.bgColor});
    const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([snap],{type:'application/json'})); a.download='note-link.json'; a.click();
  };
  const fileLoad = document.getElementById('fileLoad');
  document.getElementById('btnLoadDoc').onclick = ()=> fileLoad.click();
  fileLoad.onchange = (e)=>{ const f=e.target.files[0]; if(!f) return; const fr=new FileReader(); fr.onload=()=>{ const j=JSON.parse(fr.result); state.pages=j.pages.map(p=>({strokes:p.strokes||[],texts:p.texts||[],bg:p.bg||null,bgBitmap:null,bgSize:p.bgSize||{w:0,h:0}})); state.pageIndex=j.pageIndex||0; state.bgColor=j.bgColor||state.bgColor; updatePageCount(); render(); }; fr.readAsText(f); e.target.value=''; };

  document.getElementById('btnExportPng').onclick = ()=>{
    const a=document.createElement('a'); a.href=canvas.toDataURL('image/png'); a.download=`note-page-${state.pageIndex+1}.png`; a.click();
  };

  // background image
  const fileBg = document.getElementById('fileBg');
  document.getElementById('btnSetBg').onclick = ()=> fileBg.click();
  fileBg.onchange = async (e)=>{
    const f = e.target.files[0]; if(!f) return;
    const img = new Image(); img.onload = async ()=>{
      const cnv=document.createElement('canvas'); cnv.width=img.width; cnv.height=img.height; cnv.getContext('2d').drawImage(img,0,0);
      const p=page(); p.bg = cnv.toDataURL('image/png'); p.bgSize={w:img.width,h:img.height}; p.bgBitmap = await createImageBitmap(cnv); render();
    }; img.src = URL.createObjectURL(f); e.target.value='';
  };

  // PDF background
  const filePdf = document.getElementById('filePdf');
  document.getElementById('btnSetPdf').onclick = ()=> filePdf.click();
  filePdf.onchange = async (e)=>{
    const f = e.target.files[0]; if(!f) return;
    if(!window['pdfjsLib']){ alert('pdf.jsの読込に失敗'); return; }
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';
    const buf = await f.arrayBuffer(); const pdf = await pdfjsLib.getDocument({data:buf}).promise;
    const newPages = [];
    for(let i=1;i<=pdf.numPages;i++){
      const pg = await pdf.getPage(i);
      const vp = pg.getViewport({scale:2}); const cnv=document.createElement('canvas'); cnv.width=vp.width; cnv.height=vp.height;
      await pg.render({canvasContext:cnv.getContext('2d',{alpha:false}), viewport:vp}).promise;
      const bmp = await createImageBitmap(cnv);
      newPages.push({strokes:[],texts:[],bg:cnv.toDataURL('image/png'),bgBitmap:bmp,bgSize:{w:cnv.width,h:cnv.height}});
    }
    const empty = state.pages.length===1 && state.pages[0].strokes.length===0 && !state.pages[0].bg;
    if(empty){ state.pages=newPages; state.pageIndex=0; } else { state.pages.splice(state.pageIndex+1,0,...newPages); state.pageIndex++; }
    updatePageCount(); render(); e.target.value='';
  };

  // input / drawing
  const textInput = document.getElementById('textInput');
  function toCanvas(x,y){ const r=canvas.getBoundingClientRect(); return {x:(x-r.left - state.view.x)/state.view.scale, y:(y-r.top - state.view.y)/state.view.scale}; }
  canvas.addEventListener('pointerdown',(e)=>{
    if(state.tool==='text'){
      const c=toCanvas(e.clientX,e.clientY);
      textInput.style.left=(e.clientX-6)+'px'; textInput.style.top=(e.clientY-10)+'px'; textInput.style.display='block'; textInput.value=''; textInput.focus();
      const onConfirm = ()=>{
        const v=textInput.value.trim(); textInput.style.display='none'; textInput.onkeydown=null; textInput.onblur=null;
        if(v){ page().texts.push({text:v,x:c.x,y:c.y,color:state.pen.color,size:18,font:"'Noto Sans JP',sans-serif"}); render(); }
      };
      textInput.onkeydown=(ev)=>{ if(ev.key==='Enter'){ ev.preventDefault(); onConfirm(); } if(ev.key==='Escape'){ ev.preventDefault(); textInput.style.display='none'; } };
      textInput.onblur=onConfirm;
      return;
    }
    state.drawing=true; state.pointerId=e.pointerId;
    const p=toCanvas(e.clientX,e.clientY);
    if(state.tool==='pen'||state.tool==='hl'){
      const sz = state.tool==='hl'? state.hl.size : state.pen.size;
      const alpha = state.tool==='hl'? state.hl.alpha : state.pen.alpha;
      const color = state.tool==='hl'? state.hl.color : state.pen.color;
      state.stroke = {tool:state.tool, color, size:sz, alpha, points:[p]};
    }else if(state.tool==='eraser'){
      eraseAt(p.x,p.y,state.eraser.radius);
    }else if(state.tool==='pan'){
      state.panPrev={x:e.clientX,y:e.clientY};
    }
    canvas.setPointerCapture(e.pointerId);
    render();
  });
  canvas.addEventListener('pointermove',(e)=>{
    if(!state.drawing) return;
    const p=toCanvas(e.clientX,e.clientY);
    if(state.tool==='pen'||state.tool==='hl'){
      state.stroke.points.push(p);
    }else if(state.tool==='eraser'){
      eraseAt(p.x,p.y,state.eraser.radius);
    }else if(state.tool==='pan'){
      const dx=e.clientX-state.panPrev.x, dy=e.clientY-state.panPrev.y;
      state.view.x += dx; state.view.y += dy;
      state.panPrev={x:e.clientX,y:e.clientY};
    }
    render();
  });
  function finish(){ if(state.stroke){ page().strokes.push(state.stroke); state.stroke=null; } state.drawing=false; state.pointerId=null; render(); }
  canvas.addEventListener('pointerup',finish); canvas.addEventListener('pointercancel',finish);

  function eraseAt(x,y,r){
    const rr=r*r; const pg=page();
    pg.strokes = pg.strokes.filter(s=>{
      return !s.points.some(pt=>{ const dx=pt.x-x, dy=pt.y-y; return dx*dx+dy*dy<=rr; });
    });
  }

  // render
  function drawGuide(g){
    const r=canvas.getBoundingClientRect(); const w=r.width, h=r.height;
    ctx.save(); ctx.globalAlpha=g.opacity;
    if(g.type==='ruled'){
      ctx.strokeStyle='#64748b'; ctx.lineWidth=1;
      for(let y=g.spacing;y<h;y+=g.spacing){ ctx.beginPath(); ctx.moveTo(0,y+.5); ctx.lineTo(w,y+.5); ctx.stroke(); }
      if(g.marginLeft>0){ ctx.strokeStyle='#ef4444'; ctx.beginPath(); ctx.moveTo(g.marginLeft+.5,0); ctx.lineTo(g.marginLeft+.5,h); ctx.stroke(); }
    }else if(g.type==='grid'){
      ctx.strokeStyle='#475569'; ctx.lineWidth=1;
      for(let y=g.spacing;y<h;y+=g.spacing){ ctx.beginPath(); ctx.moveTo(0,y+.5); ctx.lineTo(w,y+.5); ctx.stroke(); }
      for(let x=g.spacing;x<w;x+=g.spacing){ ctx.beginPath(); ctx.moveTo(x+.5,0); ctx.lineTo(x+.5,h); ctx.stroke(); }
    }else if(g.type==='dot'){
      ctx.fillStyle='#64748b'; const step=g.spacing;
      for(let y=step;y<h;y+=step){ for(let x=step;x<w;x+=step){ ctx.beginPath(); ctx.arc(x,y,1,0,Math.PI*2); ctx.fill(); } }
    }else if(g.type==='eng'){
      ctx.strokeStyle='#64748b'; ctx.lineWidth=1;
      for(let y=g.spacing;y<h;y+=g.spacing){ ctx.beginPath(); ctx.moveTo(0,y+.5); ctx.lineTo(w,y+.5); ctx.stroke();
        ctx.save(); ctx.globalAlpha=Math.max(.15,g.opacity*.7); ctx.strokeStyle='#7c8ba0';
        const mid=y - g.spacing*(1-0.5); ctx.beginPath(); ctx.moveTo(0,mid+.5); ctx.lineTo(w,mid+.5); ctx.stroke(); ctx.restore();
      }
      if(g.marginLeft>0){ ctx.strokeStyle='#ef4444'; ctx.beginPath(); ctx.moveTo(g.marginLeft+.5,0); ctx.lineTo(g.marginLeft+.5,h); ctx.stroke(); }
    }
    ctx.restore();
  }
  function render(){
    const r=canvas.getBoundingClientRect(); const w=r.width, h=r.height;
    ctx.clearRect(0,0,w,h);
    ctx.fillStyle = state.bgColor; ctx.fillRect(0,0,w,h);
    ctx.save(); ctx.translate(state.view.x, state.view.y); ctx.scale(state.view.scale, state.view.scale);
    const pg = page();
    if(pg.bgBitmap){ ctx.drawImage(pg.bgBitmap,0,0); }
    drawGuide(state.guide);
    ctx.lineJoin='round'; ctx.lineCap='round';
    for(const s of pg.strokes){
      ctx.globalAlpha = s.alpha; ctx.strokeStyle=s.color; ctx.lineWidth=s.size;
      ctx.beginPath(); ctx.moveTo(s.points[0].x, s.points[0].y);
      for(let i=1;i<s.points.length;i++){ const p=s.points[i]; ctx.lineTo(p.x,p.y); }
      ctx.stroke(); ctx.globalAlpha=1;
    }
    if(state.stroke){
      const s=state.stroke; ctx.globalAlpha=s.alpha; ctx.strokeStyle=s.color; ctx.lineWidth=s.size;
      ctx.beginPath(); ctx.moveTo(s.points[0].x, s.points[0].y);
      for(let i=1;i<s.points.length;i++){ const p=s.points[i]; ctx.lineTo(p.x,p.y); }
      ctx.stroke(); ctx.globalAlpha=1;
    }
    for(const t of pg.texts||[]){
      ctx.font = "18px 'Noto Sans JP',sans-serif"; ctx.fillStyle = t.color || '#fff'; ctx.textBaseline='top'; ctx.fillText(t.text, t.x, t.y);
    }
    ctx.restore();
  }

  const pageCountEl = document.getElementById('pageCount');
  function updatePage(){ pageCountEl.textContent = `${state.pageIndex+1} / ${state.pages.length}`; }
  window.addEventListener('load', ()=>{ resizeCanvas(); updatePage(); setTimeout(resizeCanvas,0); });
  </script>
</body>
</html>
