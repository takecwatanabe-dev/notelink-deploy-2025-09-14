<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Note Link v0.9ï¼ˆç¸¦æŠ˜ã‚ŠãŸãŸã¿ãƒ»ãƒšãƒ¼ã‚¸ç§»å‹•åˆ†é›¢ãƒ»æŒ‡ç¤ºå¤–å¤‰æ›´ãªã—ï¼‰</title>
  <style>
    :root { --bg:#0f172a; --panel:#111827; --ink:#e5e7eb; --accent:#50C878; --muted:#374151; }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin: 0; background: var(--bg); color: var(--ink);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Yu Gothic", "Meiryo", sans-serif;
      overflow: hidden; }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    header { height: 48px; display:flex; align-items:center; justify-content:space-between; padding: 0 12px; background: var(--panel); border-bottom:1px solid var(--muted); user-select:none; gap:8px; }
    header .brand { display:flex; gap:8px; align-items:center; font-weight:700; }
    header .brand .dot { width:10px; height:10px; border-radius:50%; background:var(--accent); box-shadow:0 0 12px var(--accent); }
    header .actions { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .pager { display:flex; gap:6px; align-items:center; background:#0b1220; border:1px solid var(--muted); border-radius:12px; padding:4px 8px; }
    .pager .count { min-width:64px; text-align:center; font-variant-numeric: tabular-nums; }

    button, input[type='color'], select, details { background:#0b1220; color:var(--ink); border:1px solid var(--muted); border-radius:10px; padding:8px 10px; font-size:14px; height:34px; }
    button{ cursor:pointer; }
    details{ padding:6px 10px; height:auto; }
    summary{ cursor:pointer; }
    button:hover, details:hover { border-color:var(--accent); }
    button.active { outline:2px solid var(--accent); }

    /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    .wrap { display:grid; grid-template-columns: 56px 1fr; grid-template-rows: 1fr; height: calc(100% - 48px); transition: grid-template-columns .2s ease; }
    /* æŠ˜ã‚ŠãŸãŸã¿æ™‚ã§ã‚‚ 44px ã‚’æ®‹ã—ã¦è¦‹å¤±ã‚ãªã„ã‚ˆã†ã«ã™ã‚‹ */
    .wrap.collapsedX { grid-template-columns: 44px 1fr; }

    .sidebar { position:relative; background:var(--panel); border-right:1px solid var(--muted); padding:8px; display:flex; flex-direction:column; gap:8px; overflow:auto; }
    /* å‚ç›´æ–¹å‘ã®æŠ˜ã‚ŠãŸãŸã¿ï¼ˆé«˜ã•ã‚’æŠ‘ãˆã‚‹ï¼‰*/
    .sidebar.collapsedY { max-height: 44px; overflow:hidden; }

    .sidebar .toggleBar { position:absolute; top:8px; right:-10px; width:22px; height:22px; border-radius:50%; background:#0b1220; border:1px solid var(--muted); display:grid; place-items:center; font-size:12px; cursor:pointer; }
    .toolGroup { display:flex; flex-direction:column; align-items:center; gap:4px; }
    .tool { width:40px; height:40px; border-radius:12px; display:grid; place-items:center; border:1px solid var(--muted); background:#0b1220; }
    .tool.active { border-color:var(--accent); }
    .gear { width:26px; height:26px; border-radius:8px; display:none; place-items:center; border:1px solid var(--muted); font-size:12px; opacity:.85; }
    .toolGroup.active .gear{ display:grid; }
    .tool-label { font-size:10px; text-align:center; opacity:.8; }

    .stage { position:relative; background: #0b1220; }
    canvas { display:block; background: transparent; width:100%; height:100%; }
    /* ã‚­ãƒ£ãƒ³ãƒã‚¹å³ä¸Šã®æ—§ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ã¯éè¡¨ç¤ºï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ã¸ç§»å‹•ï¼‰*/
    .pageIndicator { display:none; }

    .flyout { position:absolute; top:72px; left:72px; width:360px; max-width:90vw; max-height:70vh; overflow:auto; background:rgba(17,24,39,.98); border:1px solid var(--muted); border-radius:14px; box-shadow:0 10px 32px rgba(0,0,0,.45); padding:10px; backdrop-filter: blur(6px); }
    .flyout.hidden { display:none; }
    .flyoutHeader { display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px; }
    .flyoutHeader .title { font-weight:700; }
    .dragHandle { cursor:move; opacity:.8; }
    .closeX { width:28px; height:28px; border-radius:8px; display:grid; place-items:center; }

    .panel h3 { margin:6px 0 8px; font-size:14px; opacity:.9; }
    .row { display:flex; gap:8px; align-items:center; margin-bottom:8px; flex-wrap:wrap; }
    .row input[type='range']{ width: 160px; }
    .hint { font-size:12px; opacity:.75; line-height:1.4; }

    .tabbar { display:flex; gap:6px; margin-bottom:6px; flex-wrap:wrap; }
    .tabbar button { height:30px; padding:4px 8px; border-radius:8px; }
    .tabbar button.active { background: #10212f; border-color: var(--accent); }

    .swatch { width:22px; height:22px; border-radius:6px; border:1px solid #64748b; cursor:pointer; }
    .swatchRow { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

    .textInput { position:absolute; background:#ffffff; color:#111827; border:1px solid #94a3b8; border-radius:6px; padding:4px 6px; min-width:120px; outline:none; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
</head>
<body>
  <header>
    <div class="brand"><span class="dot"></span> Note Link v0.9</div>
    <div class="actions">
      <button id="btnUndo" title="å…ƒã«æˆ»ã™ (Ctrl+Z)">â†¶</button>
      <button id="btnRedo" title="ã‚„ã‚Šç›´ã™ (Ctrl+Y)">â†·</button>

      <!-- ãƒšãƒ¼ã‚¸ç§»å‹•ï¼†å¢—æ¸›ï¼šã“ã“ã«é›†ç´„ -->
      <div class="pager">
        <button id="btnPrevPage" title="å‰ã®ãƒšãƒ¼ã‚¸ã¸">â—€</button>
        <span id="pageCount" class="count">1 / 1</span>
        <button id="btnNextPage" title="æ¬¡ã®ãƒšãƒ¼ã‚¸ã¸">â–¶</button>
        <button id="btnAddPage"  title="ãƒšãƒ¼ã‚¸è¿½åŠ ">ï¼‹</button>
        <button id="btnDelPage"  title="ã“ã®ãƒšãƒ¼ã‚¸ã‚’å‰Šé™¤">ï¼</button>
      </div>

      <button id="btnExportPng" title="PNGæ›¸ãå‡ºã—">PNGå‡ºåŠ›</button>
      <button id="btnSaveDoc" title="ãƒãƒ¼ãƒˆä¿å­˜ï¼ˆJSONï¼‰">ä¿å­˜</button>
      <button id="btnLoadDoc" title="ãƒãƒ¼ãƒˆèª­è¾¼ï¼ˆJSONï¼‰">èª­è¾¼</button>
      <input type="file" id="fileLoad" accept="application/json" style="display:none" />
      <input type="file" id="fileBg" accept="image/*" style="display:none" />
      <button id="btnSetBg" title="èƒŒæ™¯ç”»åƒï¼ˆPNG/JPGï¼‰ã‚’èª­ã¿è¾¼ã¿">èƒŒæ™¯</button>
      <input type="file" id="filePdf" accept="application/pdf" style="display:none" />
      <button id="btnSetPdf" title="PDFã‚’èƒŒæ™¯ã¨ã—ã¦èª­ã¿è¾¼ã¿ï¼ˆå„ãƒšãƒ¼ã‚¸ã¸åˆ†å‰²ï¼‰">PDF</button>
    </div>
  </header>

  <div class="wrap" id="wrap">
    <aside class="sidebar" id="sidebar">
      <!-- å‚ç›´æŠ˜ã‚ŠãŸãŸã¿ï¼šâ–³=å±•é–‹ï¼â–½=æŠ˜ã‚ŠãŸãŸã¿ -->
      <div class="toggleBar" id="toggleBar" title="ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã‚’ç¸¦ã«æŠ˜ã‚ŠãŸãŸã‚€/æˆ»ã™">â–³</div>
      <div class="toolGroup" id="groupPen">
        <button class="tool active" id="toolPen" title="ãƒšãƒ³">âœ</button>
        <button class="gear" id="gearPen" title="ãƒšãƒ³è¨­å®š">âš™</button>
        <div class="tool-label">ãƒšãƒ³</div>
      </div>
      <div class="toolGroup" id="groupHL">
        <button class="tool" id="toolHighlighter" title="è›å…‰ãƒšãƒ³">ğŸ–</button>
        <button class="gear" id="gearHL" title="è›å…‰ãƒšãƒ³è¨­å®š">âš™</button>
        <div class="tool-label">è›å…‰</div>
      </div>
      <div class="toolGroup" id="groupEraser">
        <button class="tool" id="toolEraser" title="æ¶ˆã—ã‚´ãƒ ï¼ˆã‚¹ãƒˆãƒ­ãƒ¼ã‚¯æ¶ˆå»ï¼‰">âŒ«</button>
        <button class="gear" id="gearEraser" title="æ¶ˆã—ã‚´ãƒ è¨­å®š">âš™</button>
        <div class="tool-label">æ¶ˆ</div>
      </div>
      <div class="toolGroup" id="groupPan">
        <button class="tool" id="toolPan" title="ç§»å‹•/ã‚ºãƒ¼ãƒ ï¼ˆ2æœ¬æŒ‡ãƒ»ãƒ›ã‚¤ãƒ¼ãƒ«ï¼‰">ğŸ–</button>
        <button class="gear" id="gearPan" title="ç§»å‹•è¨­å®š">âš™</button>
        <div class="tool-label">ç§»å‹•</div>
      </div>
      <div class="toolGroup" id="groupGuide">
        <button class="tool" id="toolGuide" title="ç½«ç·šãƒ»ã‚¬ã‚¤ãƒ‰">ğŸ“</button>
        <button class="gear" id="gearGuide" title="ç½«ç·šãƒ»ã‚¬ã‚¤ãƒ‰è¨­å®š">âš™</button>
        <div class="tool-label">ã‚¬ã‚¤ãƒ‰</div>
      </div>
      <div class="toolGroup" id="groupText">
        <button class="tool" id="toolText" title="ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ï¼ˆãƒ†ã‚­ã‚¹ãƒˆï¼‰">âŒ¨</button>
        <button class="gear" id="gearText" title="ãƒ†ã‚­ã‚¹ãƒˆè¨­å®š">âš™</button>
        <div class="tool-label">ãƒ†ã‚­ã‚¹ãƒˆ</div>
      </div>
      <div class="toolGroup" id="groupBg">
        <button class="tool" id="toolBg" title="èƒŒæ™¯è‰²">ğŸ¨</button>
        <button class="gear" id="gearBg" title="èƒŒæ™¯è‰²è¨­å®š">âš™</button>
        <div class="tool-label">èƒŒæ™¯</div>
      </div>
    </aside>

    <main class="stage" id="stage">
      <canvas id="canvas"></canvas>
      <div class="pageIndicator" id="pageIndicator">1 / 1</div>

      <div class="flyout hidden" id="flyout">
        <div class="flyoutHeader">
          <div class="title" id="flyoutTitle">è¨­å®š</div>
          <div style="display:flex; gap:6px; align-items:center;">
            <span class="dragHandle">â ¿</span>
            <button class="closeX" id="flyoutClose">âœ•</button>
          </div>
        </div>
        <div class="tabbar" id="tabbar"></div>
        <div id="flyoutBody"></div>
      </div>

      <input class="textInput" id="textInput" style="display:none" />
    </main>
  </div>

  <!-- Templatesï¼ˆå‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨åŒã˜ã€‚çœç•¥ã›ãšå…¨éƒ¨ç¶­æŒï¼‰ -->
  <template id="tmpl-pen"><div class="panel"><h3>ãƒšãƒ³è¨­å®š</h3>
    <div class="row"><label>è‰²</label><input type="color" id="color" value="#fffae6" /></div>
    <div class="row"><label>åŸºæº–å¤ªã•</label><input type="range" id="size" min="1" max="30" value="3" /><span id="sizeVal">3</span></div>
    <div class="row"><label>ä¸é€æ˜åº¦</label><input type="range" id="alpha" min="0.05" max="1" step="0.05" value="1" /><span id="alphaVal">1</span></div>
    <details><summary>ç­†åœ§/å‚¾ã/ãƒ‘ãƒ¼ãƒ ï¼ˆè©³ç´°ï¼‰</summary>
      <div class="row"><label><input type="checkbox" id="pressureEnable" checked /> ç­†åœ§ã‚’åæ˜ </label><span class="hint">ï¼ˆ4096æ®µéšç›¸å½“â†’0â€“1ã«æ­£è¦åŒ–ï¼‰</span></div>
      <div class="row"><label>ç­†åœ§æ„Ÿåº¦</label><input type="range" id="pressureGain" min="0" max="3" step="0.1" value="1.2" /><span id="pressureGainVal">1.2</span></div>
      <div class="row"><label><input type="checkbox" id="tiltEnable" /> å‚¾ãã§å¤ªã•è£œæ­£</label></div>
      <div class="row"><label>å‚¾ãæ„Ÿåº¦</label><input type="range" id="tiltGain" min="0" max="2" step="0.1" value="0.6" /><span id="tiltGainVal">0.6</span></div>
      <div class="row"><label><input type="checkbox" id="palmReject" checked /> ãƒ‘ãƒ¼ãƒ ãƒªã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã‚¿ãƒƒãƒç„¡åŠ¹ï¼‰</label></div>
      <div class="row"><label><input type="checkbox" id="penOnly" /> ãƒšãƒ³å°‚ç”¨ãƒ¢ãƒ¼ãƒ‰ï¼ˆpen/mouseã®ã¿ï¼‰</label></div>
    </details></div></template>

  <template id="tmpl-hl"><div class="panel"><h3>è›å…‰ãƒšãƒ³è¨­å®š</h3>
    <div class="row"><label>è‰²</label><input type="color" id="hlColor" value="#ffff66" /></div>
    <div class="row"><label>å¤ªã•</label><input type="range" id="hlSize" min="4" max="60" value="16" /><span id="hlSizeVal">16</span></div>
    <div class="row hint">â€» ä¸é€æ˜åº¦ã¯æœ€å¤§0.4ã«è‡ªå‹•åˆ¶é™</div></div></template>

  <template id="tmpl-eraser"><div class="panel"><h3>æ¶ˆã—ã‚´ãƒ è¨­å®š</h3>
    <div class="row"><label>æ¶ˆå»ç¯„å›²</label><input type="range" id="eraserRadius" min="8" max="48" value="16" /><span id="eraserRadiusVal">16</span></div>
    <div class="row hint">â€» ã„ã¾ã¯ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯å˜ä½ã€‚å°†æ¥ã€Œãƒ©ãƒãƒ¼ãƒãƒ¼å‹ã€ã‚‚è¿½åŠ å¯ã€‚</div></div></template>

  <template id="tmpl-pan"><div class="panel"><h3>ç§»å‹•/ã‚ºãƒ¼ãƒ </h3>
    <div class="row"><label>æœ€å°/æœ€å¤§ã‚ºãƒ¼ãƒ </label><input type="range" id="zoomMin" min="0.2" max="1" step="0.05" value="0.2" /><span>0.2xã€œ</span>
      <input type="range" id="zoomMax" min="2" max="8" step="0.5" value="6" /><span>ã€œ6x</span></div>
    <div class="row"><label><input type="checkbox" id="smoothPan" checked/> æ…£æ€§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«</label></div></div></template>

  <template id="tmpl-guide"><div class="panel"><h3>ç½«ç·šãƒ»ã‚¬ã‚¤ãƒ‰</h3>
    <div class="row"><label for="guidePreset">ãƒ—ãƒªã‚»ãƒƒãƒˆ</label>
      <select id="guidePreset">
        <option value="none">â€” é¸æŠ â€”</option>
        <option value="A7">æ¨ªç½« Aç½«ï¼ˆ7mmï¼‰</option>
        <option value="B6">æ¨ªç½« Bç½«ï¼ˆ6mmï¼‰</option>
        <option value="C5">æ¨ªç½« Cç½«ï¼ˆ5mmï¼‰</option>
        <option value="U8">æ¨ªç½« Uç½«ï¼ˆ8mmï¼‰</option>
        <option value="UL10">æ¨ªç½« ULç½«ï¼ˆ10mmï¼‰</option>
        <option value="ENG7">è‹±ç¿’ç½«ï¼ˆ7mmãƒ»ä¸­é–“ç·šï¼‰</option>
        <option value="DOT6">ãƒ‰ãƒƒãƒˆå…¥ã‚Šæ¨ªç½«ï¼ˆ6mmï¼‰</option>
        <option value="GRID5">æ–¹çœ¼ 5mm</option>
        <option value="GRID10">æ–¹çœ¼ 10mm</option>
        <option value="ELM10">å°å­¦ç”Ÿãƒã‚¹ 10mmï¼ˆ5ãƒã‚¹æ¯å¤ªç·šï¼‰</option>
        <option value="ELM12">å°å­¦ç”Ÿãƒã‚¹ 12mmï¼ˆ4ãƒã‚¹æ¯å¤ªç·šï¼‰</option>
        <option value="ELM15">å°å­¦ç”Ÿãƒã‚¹ 15mmï¼ˆ3ãƒã‚¹æ¯å¤ªç·šï¼‰</option>
      </select></div>
    <div class="row">
      <label for="guideType">ç¨®é¡</label>
      <select id="guideType">
        <option value="none">ãªã—</option>
        <option value="ruled">æ¨ªç½«ï¼ˆå¤§å­¦ãƒãƒ¼ãƒˆï¼‰</option>
        <option value="grid">æ–¹çœ¼</option>
        <option value="dot">ãƒ‰ãƒƒãƒˆæ–¹çœ¼</option>
        <option value="eng">è‹±ç¿’ç½«</option>
      </select></div>
    <div class="row"><label>é–“éš”(px)</label><input type="range" id="guideSpacing" min="8" max="100" value="28" /><span id="guideSpacingVal">28</span></div>
    <div class="row"><label>å·¦ãƒãƒ¼ã‚¸ãƒ³(px)</label><input type="range" id="guideMargin" min="0" max="240" value="40" /><span id="guideMarginVal">40</span></div>
    <div class="row"><label>ä¸é€æ˜åº¦</label><input type="range" id="guideOpacity" min="0.05" max="1" step="0.05" value="0.25" /><span id="guideOpacityVal">0.25</span></div>
    <div class="row"><label><input type="checkbox" id="guideExport" checked /> å‡ºåŠ›(PNG)ã«å«ã‚ã‚‹</label></div>
    <div class="hint">â€» è‹±ç¿’ç½«ã¯å„è¡Œã®ä¸­é–“ã«ã‚¬ã‚¤ãƒ‰ç·šï¼ˆè–„è‰²ï¼‰ã‚’å¼•ãã¾ã™ã€‚</div></div></template>

  <template id="tmpl-text"><div class="panel"><h3>ãƒ†ã‚­ã‚¹ãƒˆï¼ˆã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ï¼‰</h3>
    <div class="row"><label>è‰²</label><input type="color" id="textColor" value="#ffffff" /></div>
    <div class="row"><label>æ–‡å­—ã‚µã‚¤ã‚º</label><input type="range" id="textSize" min="10" max="72" value="18" /><span id="textSizeVal">18</span></div>
    <div class="row"><label>ãƒ•ã‚©ãƒ³ãƒˆ</label>
      <select id="textFont">
        <option value="'Noto Sans JP',sans-serif">ã‚´ã‚·ãƒƒã‚¯</option>
        <option value="'Hiragino Mincho ProN','Yu Mincho',serif">æ˜æœ</option>
        <option value="'Courier New',monospace">ç­‰å¹…</option>
      </select></div>
    <div class="hint">ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã‚¯ãƒªãƒƒã‚¯â†’å…¥åŠ›â†’Enterã§ç¢ºå®šã€Escã§å–æ¶ˆã€‚ç¢ºå®šå¾Œã¯ç§»å‹•ä¸å¯ï¼ˆä»Šå¾Œå¯¾å¿œå¯ï¼‰ã€‚</div></div></template>

  <template id="tmpl-bg"><div class="panel"><h3>èƒŒæ™¯è‰²</h3>
    <div class="row">æ±ºã‚æ‰“ã¡6è‰²ï¼š</div>
    <div class="row swatchRow">
      <div class="swatch" data-c="#0b1220" style="background:#0b1220" title="é»’"></div>
      <div class="swatch" data-c="#ffffff" style="background:#ffffff" title="ç™½"></div>
      <div class="swatch" data-c="#e0f7ff" style="background:#e0f7ff" title="æ·¡é’"></div>
      <div class="swatch" data-c="#e0ffe7" style="background:#e0ffe7" title="æ·¡ç·‘"></div>
      <div class="swatch" data-c="#fffce0" style="background:#fffce0" title="æ·¡é»„"></div>
      <div class="swatch" data-c="#ffe0ef" style="background:#ffe0ef" title="æ·¡ãƒ”ãƒ³ã‚¯"></div>
    </div>
    <div class="row"><label>ã‚«ã‚¹ã‚¿ãƒ </label><input type="color" id="bgPicker" value="#0b1220" /></div>
    <div class="hint">â€» èƒŒæ™¯è‰²ã¯å„ãƒšãƒ¼ã‚¸å…±é€šã€‚PDFã‚„ç”»åƒèƒŒæ™¯ãŒã‚ã‚‹å ´åˆã¯ãã¡ã‚‰ãŒå„ªå…ˆè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
  </div></template>

  <script>
    // ====== çŠ¶æ…‹ ======
    const state = {
      pages: [], pageIndex: 0, currentTool: 'pen',
      view: { scale: 1, x: 0, y: 0, min: 0.2, max: 6 }, drawing: false, pointerId: null, stroke: null,
      undoStack: [], redoStack: [],
      guide: { type: 'none', spacing: 28, opacity: 0.25, marginLeft: 40, includeExport: true, thickEvery: 0, engMid: 0.5 },
      pen: { pressureEnable: true, pressureGain: 1.2, tiltEnable: false, tiltGain: 0.6, palmReject: true, penOnly: false },
      hl: { color: '#ffff66', size: 16 },
      eraser: { radius: 16 },
      text: { color: '#ffffff', size: 18, font: "'Noto Sans JP',sans-serif" },
      ui: { flyoutOpen: false, flyoutTab: '' },
      bgColor: '#0b1220'
    };

    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const stage = document.getElementById('stage');
    const dpr = Math.max(1, window.devicePixelRatio || 1);

    function resizeCanvas(){ const r = stage.getBoundingClientRect(); canvas.width = Math.floor(r.width * dpr); canvas.height = Math.floor(r.height * dpr); ctx.setTransform(1,0,0,1,0,0); ctx.scale(dpr, dpr); render(); }
    window.addEventListener('resize', resizeCanvas);

    function newPage(){ return { strokes: [], texts: [], bg: null, bgSize: {w:0,h:0}, bgBitmap: null }; }
    state.pages.push(newPage());

    // ====== ã‚µã‚¤ãƒ‰ãƒãƒ¼æŠ˜ã‚ŠãŸãŸã¿ï¼ˆå‚ç›´ï¼‰ï¼†æ¨ªå¹…æœ€å°åŒ– ======
    const wrap = document.getElementById('wrap');
    const sidebar = document.getElementById('sidebar');
    const toggleBar = document.getElementById('toggleBar');
    toggleBar.addEventListener('click', ()=>{
      // å‚ç›´æ–¹å‘ï¼ˆé«˜ã•ï¼‰ã®æŠ˜ã‚ŠãŸãŸã¿
      sidebar.classList.toggle('collapsedY');
      // æ¨ªæ–¹å‘ã¯æœ€å°å¹…ã‚’æ®‹ã™ï¼ˆè¦‹å¤±ã‚ãªã„ï¼‰
      wrap.classList.toggle('collapsedX');
      toggleBar.textContent = sidebar.classList.contains('collapsedY') ? 'â–½' : 'â–³';
      resizeCanvas();
    });

    // ====== ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒ»ãƒ„ãƒ¼ãƒ« ======
    const groupPen = document.getElementById('groupPen');
    const groupHL = document.getElementById('groupHL');
    const groupEraser = document.getElementById('groupEraser');
    const groupPan = document.getElementById('groupPan');
    const groupGuide = document.getElementById('groupGuide');
    const groupText = document.getElementById('groupText');
    const groupBg = document.getElementById('groupBg');

    const toolPen = document.getElementById('toolPen');
    const toolHighlighter = document.getElementById('toolHighlighter');
    const toolEraser = document.getElementById('toolEraser');
    const toolPan = document.getElementById('toolPan');
    const toolGuide = document.getElementById('toolGuide');
    const toolText = document.getElementById('toolText');
    const toolBg = document.getElementById('toolBg');

    function setTool(t){
      state.currentTool = t;
      [toolPen, toolHighlighter, toolEraser, toolPan, toolGuide, toolText, toolBg].forEach(el=>el.classList.remove('active'));
      ({pen:toolPen, hl:toolHighlighter, eraser:toolEraser, pan:toolPan, guide:toolGuide, text:toolText, bg:toolBg}[t]).classList.add('active');
      [groupPen, groupHL, groupEraser, groupPan, groupGuide, groupText, groupBg].forEach(g=>g.classList.remove('active'));
      ({pen:groupPen, hl:groupHL, eraser:groupEraser, pan:groupPan, guide:groupGuide, text:groupText, bg:groupBg}[t]).classList.add('active');
      if(state.ui.flyoutOpen){ openFlyout(t); }
    }
    toolPen.onclick = ()=> setTool('pen');
    toolHighlighter.onclick = ()=> setTool('hl');
    toolEraser.onclick = ()=> setTool('eraser');
    toolPan.onclick = ()=> setTool('pan');
    toolGuide.onclick = ()=> { setTool('guide'); openFlyout('guide'); };
    toolText.onclick = ()=> setTool('text');
    toolBg.onclick = ()=> setTool('bg');

    // ====== ãƒ•ãƒ©ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆã‚®ã‚¢ï¼‰ ======
    const flyout = document.getElementById('flyout');
    const flyoutTitle = document.getElementById('flyoutTitle');
    const flyoutBody = document.getElementById('flyoutBody');
    const flyoutClose = document.getElementById('flyoutClose');
    const tabbar = document.getElementById('tabbar');

    const gearPen = document.getElementById('gearPen');
    const gearHL = document.getElementById('gearHL');
    const gearEraser = document.getElementById('gearEraser');
    const gearPan = document.getElementById('gearPan');
    const gearGuide = document.getElementById('gearGuide');
    const gearText = document.getElementById('gearText');
    const gearBg = document.getElementById('gearBg');

    gearPen.onclick = ()=> openFlyout('pen');
    gearHL.onclick = ()=> openFlyout('hl');
    gearEraser.onclick = ()=> openFlyout('eraser');
    gearPan.onclick = ()=> openFlyout('pan');
    gearGuide.onclick = ()=> openFlyout('guide');
    gearText.onclick = ()=> openFlyout('text');
    gearBg.onclick = ()=> openFlyout('bg');

    flyoutClose.onclick = ()=> { flyout.classList.add('hidden'); state.ui.flyoutOpen=false; };

    function openFlyout(tab){
      state.ui.flyoutOpen = true; state.ui.flyoutTab = tab;
      flyout.classList.remove('hidden');
      const titles = { pen:'ãƒšãƒ³è¨­å®š', hl:'è›å…‰ãƒšãƒ³è¨­å®š', eraser:'æ¶ˆã—ã‚´ãƒ è¨­å®š', pan:'ç§»å‹•/ã‚ºãƒ¼ãƒ ', guide:'ç½«ç·šãƒ»ã‚¬ã‚¤ãƒ‰', text:'ãƒ†ã‚­ã‚¹ãƒˆè¨­å®š', bg:'èƒŒæ™¯è‰²' };
      flyoutTitle.textContent = titles[tab] || 'è¨­å®š';
      tabbar.innerHTML='';
      const tabs = ['pen','hl','eraser','pan','guide','text','bg'];
      tabs.forEach(t=>{ const b=document.createElement('button'); b.textContent=titles[t]; if(t===tab) b.classList.add('active'); b.onclick=()=> openFlyout(t); tabbar.appendChild(b); });
      const tmpl = document.getElementById(`tmpl-${tab}`);
      flyoutBody.innerHTML='';
      flyoutBody.appendChild(tmpl.content.cloneNode(true));
      bindControls(tab);
    }

    // ãƒ‰ãƒ©ãƒƒã‚°ã§ãƒ‘ãƒãƒ«ç§»å‹•
    (function(){
      const handle = document.querySelector('.dragHandle');
      let dragging=false, sx=0, sy=0, ox=0, oy=0;
      handle?.addEventListener('pointerdown', (e)=>{ dragging=true; sx=e.clientX; sy=e.clientY; const r=flyout.getBoundingClientRect(); ox=r.left; oy=r.top; handle.setPointerCapture(e.pointerId); });
      handle?.addEventListener('pointermove', (e)=>{ if(!dragging) return; const dx=e.clientX-sx, dy=e.clientY-sy; flyout.style.left=(ox+dx)+'px'; flyout.style.top=(oy+dy)+'px'; });
      handle?.addEventListener('pointerup', ()=> dragging=false);
      handle?.addEventListener('pointercancel', ()=> dragging=false);
    })();

    // ====== ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®ãƒã‚¤ãƒ³ãƒ‰ ======
    function bindControls(tab){
      if(tab==='pen'){
        const color = document.getElementById('color');
        const size = document.getElementById('size'); const sizeVal = document.getElementById('sizeVal');
        const alpha = document.getElementById('alpha'); const alphaVal = document.getElementById('alphaVal');
        const pressureEnable = document.getElementById('pressureEnable');
        const pressureGain = document.getElementById('pressureGain'); const pressureGainVal = document.getElementById('pressureGainVal');
        const tiltEnable = document.getElementById('tiltEnable');
        const tiltGain = document.getElementById('tiltGain'); const tiltGainVal = document.getElementById('tiltGainVal');
        const palmReject = document.getElementById('palmReject');
        const penOnly = document.getElementById('penOnly');
        color.value = state.penColor || '#fffae6';
        size.value = state.baseSize || 3; sizeVal.textContent = size.value;
        alpha.value = state.baseAlpha || 1; alphaVal.textContent = alpha.value;
        pressureEnable.checked = state.pen.pressureEnable; pressureGain.value = state.pen.pressureGain; pressureGainVal.textContent = pressureGain.value;
        tiltEnable.checked = state.pen.tiltEnable; tiltGain.value = state.pen.tiltGain; tiltGainVal.textContent = tiltGain.value;
        palmReject.checked = state.pen.palmReject; penOnly.checked = state.pen.penOnly;
        color.oninput = ()=> state.penColor = color.value;
        size.oninput = ()=>{ state.baseSize = parseFloat(size.value); sizeVal.textContent=size.value; };
        alpha.oninput = ()=>{ state.baseAlpha = parseFloat(alpha.value); alphaVal.textContent=alpha.value; };
        pressureEnable.onchange = ()=> state.pen.pressureEnable = pressureEnable.checked;
        pressureGain.oninput = ()=>{ state.pen.pressureGain = parseFloat(pressureGain.value); pressureGainVal.textContent=pressureGain.value; };
        tiltEnable.onchange = ()=> state.pen.tiltEnable = tiltEnable.checked;
        tiltGain.oninput = ()=>{ state.pen.tiltGain = parseFloat(tiltGain.value); tiltGainVal.textContent=tiltGain.value; };
        palmReject.onchange = ()=> state.pen.palmReject = palmReject.checked;
        penOnly.onchange = ()=> state.pen.penOnly = penOnly.checked;
      }
      if(tab==='hl'){
        const c = document.getElementById('hlColor'); const s = document.getElementById('hlSize'); const sv = document.getElementById('hlSizeVal');
        c.value = state.hl.color; s.value = state.hl.size; sv.textContent = s.value;
        c.oninput = ()=> state.hl.color = c.value;
        s.oninput = ()=>{ state.hl.size = parseFloat(s.value); sv.textContent=s.value; };
      }
      if(tab==='eraser'){
        const r = document.getElementById('eraserRadius'); const rv = document.getElementById('eraserRadiusVal'); r.value = state.eraser.radius; rv.textContent=r.value; r.oninput = ()=>{ state.eraser.radius = parseFloat(r.value); rv.textContent=r.value; };
      }
      if(tab==='pan'){
        const zmin = document.getElementById('zoomMin'); const zmax = document.getElementById('zoomMax'); const smooth = document.getElementById('smoothPan');
        zmin.value = state.view.min; zmax.value = state.view.max; smooth.checked = true;
        zmin.oninput = ()=> state.view.min = parseFloat(zmin.value);
        zmax.oninput = ()=> state.view.max = parseFloat(zmax.value);
      }
      if(tab==='guide'){
        const guidePreset = document.getElementById('guidePreset');
        const guideType = document.getElementById('guideType');
        const guideSpacing = document.getElementById('guideSpacing');
        const guideSpacingVal = document.getElementById('guideSpacingVal');
        const guideMargin = document.getElementById('guideMargin');
        const guideMarginVal = document.getElementById('guideMarginVal');
        const guideOpacity = document.getElementById('guideOpacity');
        const guideOpacityVal = document.getElementById('guideOpacityVal');
        const guideExport = document.getElementById('guideExport');
        guideType.value = state.guide.type;
        guideSpacing.value = state.guide.spacing; guideSpacingVal.textContent = state.guide.spacing;
        guideMargin.value = state.guide.marginLeft; guideMarginVal.textContent = state.guide.marginLeft;
        guideOpacity.value = state.guide.opacity; guideOpacityVal.textContent = state.guide.opacity;
        guideExport.checked = state.guide.includeExport;
        guideType.onchange = ()=>{ state.guide.type = guideType.value; render(); };
        guideSpacing.oninput = ()=>{ state.guide.spacing = parseInt(guideSpacing.value); guideSpacingVal.textContent = guideSpacing.value; render(); };
        guideMargin.oninput = ()=>{ state.guide.marginLeft = parseInt(guideMargin.value); guideMarginVal.textContent = guideMargin.value; render(); };
        guideOpacity.oninput = ()=>{ state.guide.opacity = parseFloat(guideOpacity.value); guideOpacityVal.textContent = guideOpacity.value; render(); };
        guideExport.onchange = ()=> state.guide.includeExport = guideExport.checked;
        guidePreset.onchange = ()=>{
          const v = guidePreset.value;
          const apply = (type, spacing, marginLeft=40, thickEvery=0, engMid=0.5)=>{ state.guide.type=type; state.guide.spacing=spacing; state.guide.marginLeft=marginLeft; state.guide.thickEvery = thickEvery; state.guide.engMid = engMid; render(); bindControls('guide'); };
          switch(v){
            case 'A7': apply('ruled', px(7), 40, 0); break;
            case 'B6': apply('ruled', px(6), 40, 0); break;
            case 'C5': apply('ruled', px(5), 40, 0); break;
            case 'U8': apply('ruled', px(8), 40, 0); break;
            case 'UL10': apply('ruled', px(10), 40, 0); break;
            case 'ENG7': apply('eng', px(7), 40, 0, 0.5); break;
            case 'DOT6': apply('dot', px(6), 40, 0); break;
            case 'GRID5': apply('grid', px(5), 0, 0); break;
            case 'GRID10': apply('grid', px(10), 0, 0); break;
            case 'ELM10': apply('grid', px(10), 0, 5); break;
            case 'ELM12': apply('grid', px(12), 0, 4); break;
            case 'ELM15': apply('grid', px(15), 0, 3); break;
          }
        };
      }
      if(tab==='text'){
        const c = document.getElementById('textColor'); const s = document.getElementById('textSize'); const sv = document.getElementById('textSizeVal'); const f = document.getElementById('textFont');
        c.value = state.text.color; s.value = state.text.size; sv.textContent=s.value; f.value = state.text.font;
        c.oninput = ()=> state.text.color = c.value;
        s.oninput = ()=>{ state.text.size = parseFloat(s.value); sv.textContent=s.value; };
        f.onchange = ()=> state.text.font = f.value;
      }
      if(tab==='bg'){
        const picker = document.getElementById('bgPicker');
        picker.value = state.bgColor;
        picker.oninput = ()=>{ state.bgColor = picker.value; render(); };
        document.querySelectorAll('.swatch').forEach(el=>{
          el.addEventListener('click', ()=>{ const c = el.getAttribute('data-c'); state.bgColor = c; picker.value = c; render(); });
        });
      }
    }

    function px(mm){ return Math.round(mm * 3.78); }

    // ====== ãƒ˜ãƒƒãƒ€ãƒ¼æ“ä½œï¼ˆãƒšãƒ¼ã‚¸ç§»å‹•ãƒ»å¢—æ¸›ï¼‰ ======
    const pageCount = document.getElementById('pageCount');
    const btnPrevPage = document.getElementById('btnPrevPage');
    const btnNextPage = document.getElementById('btnNextPage');
    const btnAddPage = document.getElementById('btnAddPage');
    const btnDelPage = document.getElementById('btnDelPage');

    const btnExportPng = document.getElementById('btnExportPng');
    const btnSaveDoc = document.getElementById('btnSaveDoc');
    const btnLoadDoc = document.getElementById('btnLoadDoc');
    const fileLoad = document.getElementById('fileLoad');
    const btnSetBg = document.getElementById('btnSetBg'); const fileBg = document.getElementById('fileBg');
    const btnSetPdf = document.getElementById('btnSetPdf'); const filePdf = document.getElementById('filePdf');

    function updatePageIndicator(){ pageCount.textContent = `${state.pageIndex+1} / ${state.pages.length}`; }

    btnPrevPage.onclick = ()=>{ if(state.pageIndex>0){ state.pageIndex--; updatePageIndicator(); render(); } };
    btnNextPage.onclick = ()=>{ if(state.pageIndex < state.pages.length-1){ state.pageIndex++; updatePageIndicator(); render(); } };
    btnAddPage.onclick  = ()=>{ state.pages.splice(state.pageIndex+1, 0, newPage()); state.pageIndex++; pushUndo(); updatePageIndicator(); render(); };
    btnDelPage.onclick  = ()=>{ if(state.pages.length===1){ alert('ã“ã‚Œä»¥ä¸Šå‰Šé™¤ã§ãã¾ã›ã‚“'); return; } state.pages.splice(state.pageIndex, 1); state.pageIndex = Math.max(0, state.pageIndex-1); pushUndo(); updatePageIndicator(); render(); };

    // ç”»åƒèƒŒæ™¯
    btnSetBg.onclick = ()=> fileBg.click();
    fileBg.onchange = async (e)=>{ const file = e.target.files[0]; if(!file) return; const img = new Image(); img.onload = async ()=>{ const page = state.pages[state.pageIndex]; const cnv = document.createElement('canvas'); cnv.width = img.width; cnv.height = img.height; const cctx = cnv.getContext('2d'); cctx.drawImage(img,0,0); page.bg = cnv.toDataURL('image/png'); page.bgSize = {w: img.width, h: img.height}; page.bgBitmap = await createImageBitmap(cnv); render(); }; img.src = URL.createObjectURL(file); fileBg.value = ''; };

    // PDFèƒŒæ™¯
    btnSetPdf.onclick = ()=> filePdf.click();
    filePdf.onchange = async (e)=>{
      const file = e.target.files[0]; if(!file) return;
      if(!window['pdfjsLib']){ alert('pdf.js ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆæ¥ç¶šãŒã‚ã‚‹ã‹ã€ãƒ­ãƒ¼ã‚«ãƒ«åŒæ¢±ã«åˆ‡ã‚Šæ›¿ãˆã¦ãã ã•ã„ã€‚'); return; }
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';
      const buf = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
      const newPages = [];
      for(let p=1; p<=pdf.numPages; p++){
        const page = await pdf.getPage(p);
        const viewport = page.getViewport({ scale: 2 });
        const cnv = document.createElement('canvas'); cnv.width = viewport.width; cnv.height = viewport.height;
        const cctx = cnv.getContext('2d', { alpha: false });
        await page.render({ canvasContext: cctx, viewport }).promise;
        const bgUrl = cnv.toDataURL('image/png');
        const bmp = await createImageBitmap(cnv);
        const np = newPage(); np.bg = bgUrl; np.bgSize = { w: cnv.width, h: cnv.height }; np.bgBitmap = bmp;
        newPages.push(np);
      }
      const isEmpty = state.pages.length===1 && state.pages[0].strokes.length===0 && !state.pages[0].bg;
      if(isEmpty){ state.pages = newPages; state.pageIndex = 0; }
      else { state.pages.splice(state.pageIndex+1, 0, ...newPages); state.pageIndex++; }
      pushUndo(); updatePageIndicator(); render();
      filePdf.value = '';
    };

    // Undo/Redo
    const btnUndo = document.getElementById('btnUndo');
    const btnRedo = document.getElementById('btnRedo');
    function pushUndo(){ state.undoStack.push(JSON.stringify({pages: state.pages.map(p=>({...p, bgBitmap: undefined})), pageIndex: state.pageIndex, view: state.view, guide: state.guide, pen: state.pen, hl: state.hl, eraser: state.eraser, text: state.text, bgColor: state.bgColor})); state.redoStack = []; }
    function restoreFromSnapshot(json){ const snap = JSON.parse(json); state.pages = snap.pages.map(p=>({...p, bgBitmap:null})); state.pageIndex = snap.pageIndex; state.view = snap.view; state.guide = snap.guide || state.guide; state.pen = snap.pen || state.pen; state.hl = snap.hl || state.hl; state.eraser = snap.eraser || state.eraser; state.text = snap.text || state.text; state.bgColor = snap.bgColor || state.bgColor; const cur = state.pages[state.pageIndex]; if(cur && cur.bg && !cur.bgBitmap){ const img = new Image(); img.onload = async ()=>{ const cnv=document.createElement('canvas'); cnv.width=img.width; cnv.height=img.height; cnv.getContext('2d').drawImage(img,0,0); cur.bgBitmap = await createImageBitmap(cnv); render(); }; img.src = cur.bg; } render(); updatePageIndicator(); }
    btnUndo.onclick = ()=>{ if(state.undoStack.length===0) return; const cur = JSON.stringify({pages: state.pages.map(p=>({...p, bgBitmap: undefined})), pageIndex: state.pageIndex, view: state.view, guide: state.guide, pen: state.pen, hl: state.hl, eraser: state.eraser, text: state.text, bgColor: state.bgColor}); state.redoStack.push(cur); const prev = state.undoStack.pop(); restoreFromSnapshot(prev); };
    btnRedo.onclick = ()=>{ if(state.redoStack.length===0) return; const cur = JSON.stringify({pages: state.pages.map(p=>({...p, bgBitmap: undefined})), pageIndex: state.pageIndex, view: state.view, guide: state.guide, pen: state.pen, hl: state.hl, eraser: state.eraser, text: state.text, bgColor: state.bgColor}); state.undoStack.push(cur); const next = state.redoStack.pop(); restoreFromSnapshot(next); };

    // ====== ã‚¬ã‚¤ãƒ‰æç”» ======
    function pageLogicalSize(){
      const page = state.pages[state.pageIndex];
      if(page.bgSize.w && page.bgSize.h){ return {w: page.bgSize.w, h: page.bgSize.h}; }
      const r = canvas.getBoundingClientRect();
      return { w: Math.floor(r.width), h: Math.floor(r.height) };
    }
    function drawGuide(ctx){
      const g = state.guide; if(!g || g.type==='none') return;
      const {w, h} = pageLogicalSize();
      ctx.save();
      ctx.globalAlpha = g.opacity;
      if(g.type==='ruled'){
        ctx.strokeStyle = '#64748b'; ctx.lineWidth = 1;
        for(let y = g.spacing; y < h; y += g.spacing){ ctx.beginPath(); ctx.moveTo(0, y+0.5); ctx.lineTo(w, y+0.5); ctx.stroke(); }
        if(g.marginLeft>0){ ctx.strokeStyle = '#ef4444'; ctx.lineWidth = 1; ctx.beginPath(); ctx.moveTo(g.marginLeft+0.5, 0); ctx.lineTo(g.marginLeft+0.5, h); ctx.stroke(); }
      } else if(g.type==='eng'){
        ctx.strokeStyle = '#64748b'; ctx.lineWidth = 1;
        for(let y = g.spacing; y < h; y += g.spacing){
          ctx.beginPath(); ctx.moveTo(0, y+0.5); ctx.lineTo(w, y+0.5); ctx.stroke();
          ctx.save(); ctx.strokeStyle = '#7c8ba0'; ctx.globalAlpha = Math.max(0.15, g.opacity*0.7);
          const mid = y - g.spacing * (1 - g.engMid);
          ctx.beginPath(); ctx.moveTo(0, mid+0.5); ctx.lineTo(w, mid+0.5); ctx.stroke(); ctx.restore();
        }
        if(g.marginLeft>0){ ctx.strokeStyle = '#ef4444'; ctx.lineWidth = 1; ctx.beginPath(); ctx.moveTo(g.marginLeft+0.5, 0); ctx.lineTo(g.marginLeft+0.5, h); ctx.stroke(); }
      } else if(g.type==='grid'){
        const k = Math.max(0, g.thickEvery|0);
        for(let y = g.spacing; y < h; y += g.spacing){ ctx.beginPath(); ctx.strokeStyle = (k && (Math.round(y/g.spacing)%k===0))? '#7f8ea3' : '#475569'; ctx.lineWidth = (k && (Math.round(y/g.spacing)%k===0))? 1.5 : 1; ctx.moveTo(0, y+0.5); ctx.lineTo(w, y+0.5); ctx.stroke(); }
        for(let x = g.spacing; x < w; x += g.spacing){ ctx.beginPath(); ctx.strokeStyle = (k && (Math.round(x/g.spacing)%k===0))? '#7f8ea3' : '#475569'; ctx.lineWidth = (k && (Math.round(x/g.spacing)%k===0))? 1.5 : 1; ctx.moveTo(x+0.5, 0); ctx.lineTo(x+0.5, h); ctx.stroke(); }
      } else if(g.type==='dot'){
        ctx.fillStyle = '#64748b'; const r = 1; const step = g.spacing;
        for(let y = step; y < h; y += step){ for(let x = step; x < w; x += step){ ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI*2); ctx.fill(); } }
      }
      ctx.restore();
    }

    // ====== ãƒ†ã‚­ã‚¹ãƒˆæç”» ======
    function drawTexts(ctx){
      const page = state.pages[state.pageIndex];
      ctx.save();
      for(const t of page.texts){ ctx.font = `${t.size}px ${t.font}`; ctx.fillStyle = t.color; ctx.textBaseline = 'top'; ctx.fillText(t.text, t.x, t.y); }
      ctx.restore();
    }

    // ====== æç”» ======
    function drawStroke(ctx, s){ if(!s.points || s.points.length<2) return; ctx.lineJoin = 'round'; ctx.lineCap = 'round'; ctx.globalAlpha = s.alpha; ctx.strokeStyle = s.color; ctx.lineWidth = s.size; ctx.beginPath(); ctx.moveTo(s.points[0].x, s.points[0].y); for(let i=1;i<s.points.length;i++){ const p = s.points[i]; ctx.lineTo(p.x, p.y); } ctx.stroke(); ctx.globalAlpha = 1; }

    function baseRender(){
      const {width, height} = canvas.getBoundingClientRect();
      ctx.clearRect(0,0,width,height);
      ctx.save();
      ctx.fillStyle = state.bgColor; ctx.fillRect(0,0,width,height);
      ctx.restore();
      ctx.save();
      const v = state.view; ctx.translate(v.x, v.y); ctx.scale(v.scale, v.scale);
      const page = state.pages[state.pageIndex];
      if(page.bgBitmap){ ctx.drawImage(page.bgBitmap,0,0); }
      else if(page.bg){ const img = new Image(); img.onload = async ()=>{ const cnv=document.createElement('canvas'); cnv.width=img.width; cnv.height=img.height; cnv.getContext('2d').drawImage(img,0,0); page.bgBitmap = await createImageBitmap(cnv); render(); }; img.src = page.bg; }
      drawGuide(ctx);
      for(const s of page.strokes){ drawStroke(ctx, s); }
      if(state.stroke) drawStroke(ctx, state.stroke);
      drawTexts(ctx);
      ctx.restore();
    }
    let render = baseRender;

    function effectiveSize(base, e){
      let sz = base;
      if(state.currentTool==='pen'){
        if(state.pen.pressureEnable && (e && typeof e.pressure === 'number')){ const gain = Math.max(0, state.pen.pressureGain); sz *= (0.4 + e.pressure * gain); }
        if(state.pen.tiltEnable && (typeof e.tiltX==='number' || typeof e.altitudeAngle==='number')){ let tiltFactor = 1; if(typeof e.altitudeAngle === 'number'){ const a = Math.max(0.0001, e.altitudeAngle); tiltFactor = 1 + (1 - a) * state.pen.tiltGain; } else { const t = Math.min(90, Math.sqrt((e.tiltX||0)**2 + (e.tiltY||0)**2)); tiltFactor = 1 + (t/90) * state.pen.tiltGain; } sz *= tiltFactor; }
      }
      return Math.max(0.5, Math.min(60, sz));
    }

    function toCanvasCoords(clientX, clientY){ const r = canvas.getBoundingClientRect(); const x = (clientX - r.left - state.view.x) / state.view.scale; const y = (clientY - r.top - state.view.y) / state.view.scale; return {x,y}; }

    // ====== å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆ ======
    let pointers = new Map();
    const textInput = document.getElementById('textInput');

    canvas.addEventListener('pointerdown', (e)=>{
      if(state.pen.palmReject && e.pointerType==='touch') return;
      if(state.pen.penOnly && !(e.pointerType==='pen' || e.pointerType==='mouse')) return;

      if(state.currentTool==='text'){
        const c = toCanvasCoords(e.clientX, e.clientY);
        textInput.style.left = (e.clientX - 6) + 'px';
        textInput.style.top = (e.clientY - 10) + 'px';
        textInput.style.display = 'block';
        textInput.value = '';
        textInput.focus();
        const onConfirm = ()=>{
          const val = textInput.value.trim();
          if(val){ const page = state.pages[state.pageIndex]; page.texts.push({ x: c.x, y: c.y, text: val, color: state.text.color, size: state.text.size, font: state.text.font }); pushUndo(); render(); }
          textInput.style.display = 'none'; textInput.value=''; textInput.onkeydown=null; textInput.onblur=null;
        };
        textInput.onkeydown = (ke)=>{ if(ke.key==='Enter'){ onConfirm(); } if(ke.key==='Escape'){ textInput.style.display='none'; textInput.value=''; } };
        textInput.onblur = ()=> onConfirm
