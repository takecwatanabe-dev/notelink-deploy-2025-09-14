<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Note Link v0.5.x – モバイル向けデモ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-neutral-50">
  <div id="root"></div>
  <script type="text/babel">
    const { useEffect, useMemo, useRef, useState } = React;
    const PX_PER_MM = 3.78;
    const defaultStyle = { lineType: "ruled", ruledSpacingMm: 10, gridEnabled: false, gridSizeMm: 10 };
    const STORAGE_KEY = "notelink.v0.5.mobile.demo";
    const loadState = () => { try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || ""); } catch { return null; } };
    const saveState = (s) => localStorage.setItem(STORAGE_KEY, JSON.stringify(s));
    const uuid = () => Math.random().toString(36).slice(2, 10);
    function App() {
      const init = useMemo(() => {
        const s = loadState();
        if (s) return s;
        const first = { id: uuid(), title: "", content: "", style: { ...defaultStyle } };
        return { pages: [first], index: 0, pdfs: [] };
      }, []);
      const [pages, setPages] = useState(init.pages);
      const [index, setIndex] = useState(init.index);
      const [pdfs, setPdfs] = useState(init.pdfs);
      const current = pages[index];
      useEffect(() => { saveState({ pages, index, pdfs }); }, [pages, index, pdfs]);
      const [isMobile, setIsMobile] = useState(false);
      useEffect(() => {
        const onResize = () => setIsMobile(window.innerWidth < 640);
        onResize(); window.addEventListener('resize', onResize);
        return () => window.removeEventListener('resize', onResize);
      }, []);
      const ruledBg = useMemo(() => {
        if (!current) return undefined;
        if (current.style.lineType !== "ruled") return undefined;
        const gapPx = current.style.ruledSpacingMm * PX_PER_MM;
        return { backgroundImage: "linear-gradient(to bottom, rgba(0,0,0,0.08) 1px, transparent 1px)", backgroundSize: `100% ${gapPx}px` };
      }, [current]);
      const gridOverlay = useMemo(() => {
        if (!current?.style.gridEnabled) return undefined;
        const sz = current.style.gridSizeMm * PX_PER_MM;
        const color = "rgba(0,0,0,0.08)";
        return { backgroundImage: `linear-gradient(${color} 1px, transparent 1px), linear-gradient(90deg, ${color} 1px, transparent 1px)`, backgroundSize: `${sz}px ${sz}px` };
      }, [current]);
      const addPage = () => {
        if (!current) return;
        const newPage = { id: uuid(), title: current.title, content: "", style: { ...current.style } };
        const newPages = [...pages, newPage]; setPages(newPages); setIndex(newPages.length - 1);
      };
      const prev = () => setIndex(i => Math.max(0, i - 1));
      const next = () => setIndex(i => Math.min(pages.length - 1, i + 1));
      const fileInputRef = useRef(null);
      const addPdf = (e) => { const f = e.target.files?.[0]; if (!f) return; const item = { id: uuid(), name: f.name, addedAt: Date.now() }; setPdfs(lst => [item, ...lst]); e.target.value = ""; };
      const removePdf = (id) => setPdfs(lst => lst.filter(x => x.id !== id));
      const taRef = useRef(null);
      const updatePage = (patch) => { setPages(prev => prev.map((p, i) => i === index ? { ...p, ...patch, style: { ...p.style, ...(patch.style || {}) } } : p)); };
      const applyHighlight = () => {
        const ta = taRef.current; if (!ta) return;
        const start = ta.selectionStart; const end = ta.selectionEnd; if (start === end) return;
        const before = current.content.slice(0, start); const sel = current.content.slice(start, end); const after = current.content.slice(end);
        updatePage({ content: `${before}[[HL]]${sel}[[/HL]]${after}` });
        setTimeout(() => { ta.focus(); ta.setSelectionRange(end + 10, end + 10); }, 0);
      };
      const addSticky = () => updatePage({ content: (current?.content || "") + "\\n[付箋]\\n" });
      if (!current) return <div className="p-4">No pages</div>;
      const hasInput = (current.content ?? "").length > 0;
      return (
        <div className="w-full min-h-screen bg-neutral-50">
          <div className="sticky top-0 z-40 bg-white/80 backdrop-blur border-b">
            <div className="max-w-5xl mx-auto px-3 py-2 flex items-center gap-2">
              <div className="flex items-center gap-2">
                <button className="px-2 py-1 rounded border" onClick={prev}>◀</button>
                <div className="text-sm text-neutral-600">{isMobile ? `Pg ${index + 1}/${pages.length}` : `ページ ${index + 1} / ${pages.length}`}</div>
                <button className="px-2 py-1 rounded border" onClick={next}>▶</button>
              </div>
              <div className="flex-1" />
              <div className="flex items-center gap-2">
                <input type="file" accept="application/pdf" className="hidden" ref={fileInputRef} onChange={addPdf} />
                <button className="px-2 py-1 rounded border" onClick={() => fileInputRef.current?.click()}>PDF追加</button>
                <button className="px-2 py-1 rounded border" onClick={() => alert('ローカル保存（デモ）完了')}>保存</button>
                <button className="px-2 py-1 rounded bg-black text-white" onClick={() => alert('共有リンク発行（デモ）')}>共有</button>
              </div>
            </div>
          </div>
          <div className="max-w-5xl mx-auto p-3 grid grid-cols-1 lg:grid-cols-[1fr_320px] gap-3">
            <div className="bg-white border rounded-xl shadow-sm">
              <div className="p-3 sm:p-4">
                <div className="flex flex-col sm:flex-row gap-2 mb-3">
                  <input value={current.title} onChange={(e) => updatePage({ title: e.target.value })} placeholder="タイトル" className="px-3 py-2 border rounded w-full text-base sm:text-lg" />
                  <div className="flex gap-2">
                    <button className="px-3 py-2 rounded border" onClick={addPage}>＋ ページ追加</button>
                    <button className="px-3 py-2 rounded border" onClick={addSticky}>付箋</button>
                    <button className="px-3 py-2 rounded border" onClick={applyHighlight}>ハイライト</button>
                  </div>
                </div>
                <div className="flex flex-wrap items-center gap-2 mb-1 text-sm">
                  <span className="text-neutral-600">ツール:</span>
                  <button className="px-2 py-1 rounded border">✒ ペン</button>
                  <button className="px-2 py-1 rounded border">🧽 消しゴム</button>
                  <button className="px-2 py-1 rounded border">🖍 マーカー</button>
                  <select className="px-2 py-1 border rounded"><option>細</option><option>中</option><option>太</option></select>
                </div>
                <div className="flex flex-wrap gap-2 items-center mb-3">
                  <label className="text-sm text-neutral-600">罫線幅</label>
                  <select className="px-2 py-1 border rounded" value={String(current.style.ruledSpacingMm)} onChange={(e) => !hasInput && updatePage({ style: { ...current.style, ruledSpacingMm: Number(e.target.value) } })} disabled={hasInput}>
                    <option value="10">10 mm</option>
                    <option value="8">8 mm</option>
                    <option value="6">6 mm</option>
                  </select>
                  {hasInput && <span className="text-xs text-neutral-500">（入力開始後は罫線幅を固定）</span>}
                  <div className="w-px h-6 bg-neutral-200 mx-1"></div>
                  <button className={"px-3 py-1 rounded border " + (current.style.gridEnabled ? "bg-black text-white" : "")} onClick={() => updatePage({ style: { ...current.style, gridEnabled: !current.style.gridEnabled } })}>グラフ升目 {current.style.gridEnabled ? "ON" : "OFF"}</button>
                  <select className="px-2 py-1 border rounded" value={String(current.style.gridSizeMm)} onChange={(e) => updatePage({ style: { ...current.style, gridSizeMm: Number(e.target.value) } })}>
                    <option value="10">10 mm</option>
                    <option value="8">8 mm</option>
                    <option value="5">5 mm</option>
                  </select>
                </div>
                <div className="relative border rounded-xl overflow-hidden">
                  <div className="absolute inset-0 pointer-events-none" style={gridOverlay}></div>
                  <textarea ref={taRef} value={current.content} onChange={(e) => updatePage({ content: e.target.value })} placeholder="ここにノートを書き始める…（スマホは閲覧中心・軽微な編集）" className="min-h-[60vh] w-full p-3 text-base leading-relaxed resize-vertical bg-white" style={ruledBg}></textarea>
                </div>
              </div>
            </div>
            <div className="space-y-3">
              <div className="bg-white border rounded-xl shadow-sm p-3">
                <div className="font-medium mb-2">PDFライブラリ（保管・管理 叩き台）</div>
                <ul className="space-y-2 max-h-[40vh] overflow-auto">
                  {pdfs.length === 0 && (<li className="text-sm text-neutral-500">まだPDFがありません。「PDF追加」から登録してください。</li>)}
                  {pdfs.map(p => (<li key={p.id} className="flex items-center justify-between text-sm border rounded px-2 py-1"><span className="truncate" title={p.name}>{p.name}</span><button className="px-2 py-1 rounded border" onClick={() => removePdf(p.id)}>削除</button></li>))}
                </ul>
              </div>
              <div className="bg-white border rounded-xl shadow-sm p-3">
                <div className="font-medium mb-1">スマホ最適化（方針）</div>
                <ol className="list-decimal list-inside text-sm text-neutral-700 space-y-1">
                  <li>スマホは「閲覧・共有」を優先。編集UIは最小限。</li>
                  <li>上部/下部のページャを固定して移動を簡単に。</li>
                  <li>罫線と方眼はCSSでレンダリングし縮尺の影響を受けにくく。</li>
                  <li>今後「閲覧モード／編集モード」トグルを追加予定。</li>
                </ol>
              </div>
            </div>
          </div>
          <div className="sm:hidden sticky bottom-0 z-40 bg-white/90 backdrop-blur border-t">
            <div className="max-w-5xl mx-auto px-3 py-2 flex items-center gap-2">
              <button className="px-2 py-1 rounded border" onClick={prev}>◀</button>
              <div className="text-sm text-neutral-600">ページ {index + 1} / {pages.length}</div>
              <button className="px-2 py-1 rounded border" onClick={next}>▶</button>
              <div className="flex-1"></div>
              <button className="px-3 py-1 rounded bg-black text-white" onClick={() => alert('共有（デモ）')}>共有</button>
            </div>
          </div>
        </div>
      );
    }
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
