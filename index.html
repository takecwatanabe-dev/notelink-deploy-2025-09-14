<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Note Link v0.6.3a – 安定読込（CDNフォールバック）</title>
  <style>
    body{margin:0;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Apple Color Emoji,Noto Color Emoji}
    .banner{position:fixed;left:0;right:0;top:0;padding:.5rem 1rem;background:#fffbeb;border-bottom:1px solid #fde68a;color:#92400e;font-size:14px;z-index:9999;display:none}
    .ok{background:#ecfeff;border-color:#a5f3fc;color:#065f46}
  </style>
  <div id="banner" class="banner">読み込み中…</div>
  <script>
    // Helper to show banner messages
    function showBanner(msg, ok){ var el=document.getElementById('banner'); el.textContent=msg; el.style.display='block'; if(ok){el.classList.add('ok');} }
    window.addEventListener('error', function(e){ showBanner('エラー: '+(e.message||e.error), false); });
  </script>
  <!-- Primary CDNs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script>
    (function ensureCDNs(){
      function add(src){ var s=document.createElement('script'); s.src=src; s.crossOrigin='anonymous'; document.head.appendChild(s); return new Promise(r=>{s.onload=r; s.onerror=r}); }
      var promises=[];
      if(!window.React){ showBanner('ReactのCDN読込に失敗。フォールバックを使用します…'); promises.push(add('https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js')); }
      if(!window.ReactDOM){ showBanner('ReactDOMのCDN読込に失敗。フォールバックを使用します…'); promises.push(add('https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js')); }
      if(!window.Babel){ showBanner('BabelのCDN読込に失敗。フォールバックを使用します…'); promises.push(add('https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js')); }
      Promise.all(promises).then(function(){ showBanner('読み込み完了。', true); setTimeout(()=>{document.getElementById('banner').style.display='none';},1200); });
    })();
  </script>
</head>
<body>
  <div id="root">読み込み中…</div>

  <script type="text/babel">
    const {useEffect,useMemo,useRef,useState} = React;
    const PX_PER_MM = 3.78;
    const VERSION="v0.6.3a";
    const STORAGE="notelink.v0.6.3";
    const MODEKEY="notelink.mode";
    const uid = ()=>Math.random().toString(36).slice(2,10);

    function App(){
      const init = (()=>{
        try{const s=JSON.parse(localStorage.getItem(STORAGE)||""); if(s) return s;}catch{}
        return {pages:[{id:uid(),kind:'note',title:'',content:'',style:{lineType:'ruled',ruledSpacingMm:10,gridEnabled:false,gridSizeMm:10},notes:[],blocks:[]}],index:0,pageSize:'a4',orientation:'portrait',zoom:1};
      })();
      const [pages,setPages]=useState(init.pages);
      const [index,setIndex]=useState(init.index||0);
      const cur=pages[index];
      const [mode,setMode]=useState(()=>localStorage.getItem(MODEKEY)||"edit");
      const isView = mode!=="edit";
      const setModeBoth=(m)=>{ setMode(m); localStorage.setItem(MODEKEY,m); };

      useEffect(()=>{ localStorage.setItem(STORAGE, JSON.stringify({pages,index,pageSize:'a4',orientation:'portrait',zoom:1})); },[pages,index]);

      return (
        <div style={{padding:'16px'}}>
          <div style={{display:'flex',alignItems:'center',gap:'8px'}}>
            <div style={{fontWeight:600}}>Note Link <span style={{fontSize:12,color:'#6b7280'}}>{VERSION}</span></div>
            <div style={{marginLeft:'auto'}}>
              <button onClick={()=>setModeBoth("view")} style={{padding:'6px 10px',border:'1px solid #e5e7eb',borderRadius:6,background:isView?'#111827':'#fff',color:isView?'#fff':'#111827'}}>閲覧</button>
              <button onClick={()=>setModeBoth("edit")} style={{padding:'6px 10px',border:'1px solid #e5e7eb',borderRadius:6,background:!isView?'#111827':'#fff',color:!isView?'#fff':'#111827'}}>編集</button>
            </div>
          </div>
          <div style={{marginTop:12}}>
            <input value={cur.title||''} onChange={e=>!isView&&setPages(p=>p.map((pg,i)=>i===index?{...pg,title:e.target.value}:pg))} placeholder="タイトル" style={{padding:'10px',width:'100%',border:'1px solid #e5e7eb',borderRadius:8}} readOnly={isView}/>
          </div>
          <div style={{marginTop:12}}>
            <textarea value={cur.content||''} onChange={e=>!isView&&setPages(p=>p.map((pg,i)=>i===index?{...pg,content:e.target.value}:pg))}
              placeholder={isView?"閲覧モードです（編集は上で切替）":"ここにノートを書き始める…"} style={{width:'100%',height:'60vh',border:'1px solid #e5e7eb',borderRadius:12,padding:'12px',lineHeight:'28px'}} readOnly={isView}></textarea>
          </div>
        </div>
      );
    }
    window.addEventListener('DOMContentLoaded', ()=>{
      try{
        ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
      }catch(e){
        const el=document.getElementById('root'); el.textContent="初期化エラー: "+e.message;
        document.getElementById('banner').style.display='block';
        document.getElementById('banner').textContent='初期化エラー: '+e.message;
      }
    });
  </script>
  <noscript>JavaScriptを有効にしてください。</noscript>
</body>
</html>
