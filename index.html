<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Note Link v0.2</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0b1220">
<style>
:root{ --bg:#0b1220; --panel:#111827; --ink:#e5e7eb; --muted:#374151; --accent:#50C878; }
*{ box-sizing:border-box; }
html,body{ height:100%; margin:0; }
body{ background:var(--bg); color:var(--ink); font-family:system-ui,-apple-system,"Noto Sans JP",sans-serif; overflow:hidden; }
header{ height:48px; display:flex; align-items:center; justify-content:space-between; gap:8px; padding:0 12px; background:var(--panel); border-bottom:1px solid var(--muted); }
header .brand{ display:flex; align-items:center; gap:8px; font-weight:700; }
header .dot{ width:10px; height:10px; border-radius:50%; background:var(--accent); box-shadow:0 0 10px var(--accent); }
header .ver{ font-size:12px; padding:2px 8px; border:1px solid var(--muted); border-radius:10px; opacity:.85; }
header .actions{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
button,input[type=color],input[type=file]{ background:#0b1220; color:var(--ink); border:1px solid var(--muted); border-radius:10px; padding:8px 10px; height:34px; font-size:14px; cursor:pointer; }
button:hover{ border-color:var(--accent); }
button.active{ outline:2px solid var(--accent); }
.wrap{ display:grid; grid-template-columns:56px 1fr; height:calc(100% - 48px); }
.sidebar{ background:var(--panel); border-right:1px solid var(--muted); padding:8px; display:flex; flex-direction:column; gap:8px; overflow:auto; }
.sidebar.collapsedY{ max-height:56px; overflow:hidden; }
.toolGroup{ display:flex; flex-direction:column; align-items:center; gap:4px; }
.tool{ width:40px; height:40px; border-radius:12px; display:grid; place-items:center; border:1px solid var(--muted); background:#0b1220; }
.tool-label{ font-size:10px; opacity:.8; }
.stage{ position:relative; }
canvas{ display:block; width:100%; height:100%; background:transparent; }
.flyout{ position:absolute; top:70px; left:70px; width:320px; max-width:90vw; max-height:70vh; overflow:auto; background:#111827ef; border:1px solid var(--muted); border-radius:14px; padding:10px; }
.flyout.hidden{ display:none; }
.row{ display:flex; gap:8px; align-items:center; margin-bottom:8px; flex-wrap:wrap; }
.textInput{ position:absolute; background:#fff; color:#111; border:1px solid #94a3b8; border-radius:6px; padding:4px 6px; min-width:120px; outline:none; }
.badge{ font-size:12px; padding:2px 6px; border:1px solid var(--muted); border-radius:8px; }
.hint{ font-size:12px; opacity:.8; }
.modal{ position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.4); }
.modal.open{ display:grid; }
.modal .card{ width:min(560px,92vw); background:#111827; border:1px solid var(--muted); border-radius:14px; padding:14px; }
.card h3{ margin:0 0 8px; }
.card .sep{ height:1px; background:#2b3443; margin:8px 0; }
.card .row b{ min-width:7em; display:inline-block; }
</style>
</head>
<body>
<header>
  <div class="brand"><span class="dot"></span> Note Link <span class="ver">v0.2</span><span id="modeBadge" class="badge">ç”Ÿå¾’ãƒ¢ãƒ¼ãƒ‰</span></div>
  <div class="actions">
    <button id="btnUndo" title="å…ƒã«æˆ»ã™">â†¶</button>
    <button id="btnRedo" title="ã‚„ã‚Šç›´ã™">â†·</button>
    <button id="btnSave">ä¿å­˜(JSON)</button>
    <button id="btnLoad">èª­è¾¼(JSON)</button>
    <input id="fileLoad" type="file" accept="application/json" style="display:none">
    <button id="btnExport" title="PNGå‡ºåŠ›">PNG</button>
    <button id="btnShare">å…±æœ‰ã‚¬ã‚¤ãƒ‰</button>
    <button id="btnToggleMode" title="æ•™å¸«/ç”Ÿå¾’ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿">æ•™å¸«ãƒ¢ãƒ¼ãƒ‰</button>
  </div>
</header>

<div class="wrap">
  <aside class="sidebar" id="sidebar">
    <div class="toolGroup" id="groupToggle">
      <button class="tool" id="toggleBar">â–³</button>
      <div class="tool-label">é–‹é–‰</div>
    </div>
    <div class="toolGroup"><button class="tool active" id="toolPen">âœ</button><div class="tool-label">ãƒšãƒ³</div></div>
    <div class="toolGroup"><button class="tool" id="toolHL">ğŸ–</button><div class="tool-label">è›å…‰</div></div>
    <div class="toolGroup"><button class="tool" id="toolEraser">âŒ«</button><div class="tool-label">æ¶ˆ</div></div>
    <div class="toolGroup"><button class="tool" id="toolPan">ğŸ–</button><div class="tool-label">ç§»å‹•</div></div>
    <div class="toolGroup"><button class="tool" id="toolText">âŒ¨</button><div class="tool-label">ãƒ†ã‚­ã‚¹ãƒˆ</div></div>
    <div class="toolGroup"><button class="tool" id="gearSingle">âš™</button><div class="tool-label">è¨­å®š</div></div>
  </aside>
  <main class="stage" id="stage">
    <canvas id="canvas"></canvas>

    <!-- è¨­å®šãƒ‘ãƒãƒ« -->
    <div id="flyout" class="flyout hidden">
      <h3 id="flyoutTitle">è¨­å®š</h3>
      <div id="flyoutBody"></div>
      <div class="row"><button id="flyoutClose">é–‰ã˜ã‚‹</button></div>
    </div>

    <input id="textInput" class="textInput" style="display:none">
  </main>
</div>

<!-- å…±æœ‰ã‚¬ã‚¤ãƒ‰ï¼ˆç”Ÿå¾’/æ•™å¸«å…±é€šã®å°ç·šï¼‰ -->
<div id="shareModal" class="modal">
  <div class="card">
    <h3>å…±æœ‰ã‚¬ã‚¤ãƒ‰</h3>
    <div class="sep"></div>
    <div class="row"><b>1) ä¿å­˜</b>ã€Œä¿å­˜(JSON)ã€ã§ <code>note-link.json</code> ã‚’ä¿å­˜</div>
    <div class="row"><b>2) å…±æœ‰</b> Google ãƒ‰ãƒ©ã‚¤ãƒ–ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ â†’ å…±æœ‰ãƒªãƒ³ã‚¯ã‚’ä½œæˆ</div>
    <div class="row"><b>3) æå‡º</b> å…ˆç”Ÿã¸å…±æœ‰ãƒªãƒ³ã‚¯ã‚’é€ä¿¡ï¼ˆãƒ¡ãƒ¼ãƒ«/LINE/ãƒ•ã‚©ãƒ¼ãƒ ï¼‰</div>
    <div class="sep"></div>
    <div class="row hint">â€» æ•™å¸«ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã€å—ã‘å–ã£ãŸJSONã‚’ã€Œèª­è¾¼ã€ã§é–‹ãã€æ›¸è¾¼ã¿ä¸å¯ã®ã¾ã¾ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ãã¾ã™ã€‚</div>
    <div class="row" style="justify-content:flex-end; gap:8px;">
      <button id="btnCopySteps">æ‰‹é †ã‚’ã‚³ãƒ”ãƒ¼</button>
      <button id="btnCloseShare">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>

<!-- ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆæœ€å°ï¼‰ -->
<template id="tmpl-pen"><div class="row">
  <label>è‰²</label><input type="color" id="penColor" value="#fffae6">
  <label>å¤ªã•</label><input type="range" id="penSize" min="1" max="30" value="3"><span id="penSizeVal">3</span>
  <label>ä¸é€æ˜åº¦</label><input type="range" id="penAlpha" min="0.05" max="1" step="0.05" value="1"><span id="penAlphaVal">1</span>
</div></template>

<template id="tmpl-hl"><div class="row">
  <label>è‰²</label><input type="color" id="hlColor" value="#ffff66">
  <label>å¤ªã•</label><input type="range" id="hlSize" min="4" max="60" value="16"><span id="hlSizeVal">16</span>
  <span class="hint">è›å…‰ã¯è‡ªå‹•ã§åŠé€æ˜ï¼ˆ0.35ï¼‰</span>
</div></template>

<template id="tmpl-eraser"><div class="row">
  <label>æ¶ˆã—ç¯„å›²</label><input type="range" id="eraserRadius" min="8" max="48" value="16"><span id="eraserRadiusVal">16</span>
</div></template>

<script>
/* ===== PWAç™»éŒ² ===== */
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("service-worker.js").catch(console.warn);
  });
}

/* ===== çŠ¶æ…‹ ===== */
const state = {
  pages: [{strokes:[], texts:[]}], pageIndex:0,
  tool: "pen",
  pen: { color:"#fffae6", size:3, alpha:1 },
  hl: { color:"#ffff66", size:16, alpha:.35 },
  eraser: { radius:16 },
  view: { x:0, y:0, scale:1 },
  drawing:false, stroke:null,
  mode:"student" // "teacher"=èª­ã¿å–ã‚Šå°‚ç”¨
};

/* ===== è¦ç´  ===== */
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const stage = document.getElementById("stage");
const dpr = Math.max(1, window.devicePixelRatio||1);
const sidebar = document.getElementById("sidebar");
const toggleBar = document.getElementById("toggleBar");
const gearSingle = document.getElementById("gearSingle");
const flyout = document.getElementById("flyout");
const flyoutBody = document.getElementById("flyoutBody");
const flyoutTitle = document.getElementById("flyoutTitle");
const flyoutClose = document.getElementById("flyoutClose");
const textInput = document.getElementById("textInput");
const modeBadge = document.getElementById("modeBadge");

/* ===== ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ ===== */
function resizeCanvas(){
  const r = stage.getBoundingClientRect();
  canvas.width = Math.floor(r.width * dpr);
  canvas.height = Math.floor(r.height * dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
  render();
}
window.addEventListener("resize", resizeCanvas);
toggleBar.addEventListener("click", ()=>{
  const collapsed = sidebar.classList.toggle("collapsedY");
  toggleBar.textContent = collapsed ? "â–½" : "â–³";
  resizeCanvas();
});

/* ===== ãƒ„ãƒ¼ãƒ« ===== */
const btns = {
  pen: document.getElementById("toolPen"),
  hl: document.getElementById("toolHL"),
  eraser: document.getElementById("toolEraser"),
  pan: document.getElementById("toolPan"),
  text: document.getElementById("toolText"),
};
Object.entries(btns).forEach(([k, el])=> el.addEventListener("click", ()=>{
  closeFlyout();
  state.tool = k;
  Object.values(btns).forEach(b=>b.classList.remove("active"));
  el.classList.add("active");
}));
gearSingle.addEventListener("click", ()=>{
  openFlyout(state.tool);
});
function openFlyout(kind){
  flyout.classList.remove("hidden");
  flyoutTitle.textContent = {pen:"ãƒšãƒ³è¨­å®š", hl:"è›å…‰ãƒšãƒ³è¨­å®š", eraser:"æ¶ˆã—ã‚´ãƒ è¨­å®š"}[kind] || "è¨­å®š";
  const map = { pen:"tmpl-pen", hl:"tmpl-hl", eraser:"tmpl-eraser" };
  const tmpl = document.getElementById(map[kind]);
  flyoutBody.innerHTML = "";
  if (tmpl) flyoutBody.appendChild(tmpl.content.cloneNode(true));
  bindControls(kind);
}
function closeFlyout(){ flyout.classList.add("hidden"); }
flyoutClose.addEventListener("click", closeFlyout);

function bindControls(kind){
  if(kind==="pen"){
    const c = flyoutBody.querySelector("#penColor");
    const s = flyoutBody.querySelector("#penSize");
    const sv= flyoutBody.querySelector("#penSizeVal");
    const a = flyoutBody.querySelector("#penAlpha");
    const av= flyoutBody.querySelector("#penAlphaVal");
    c.value = state.pen.color; s.value = state.pen.size; sv.textContent = s.value; a.value = state.pen.alpha; av.textContent = a.value;
    c.oninput = ()=> state.pen.color = c.value;
    s.oninput = ()=>{ state.pen.size = +s.value; sv.textContent = s.value; };
    a.oninput = ()=>{ state.pen.alpha = +a.value; av.textContent = a.value; };
  }
  if(kind==="hl"){
    const c = flyoutBody.querySelector("#hlColor");
    const s = flyoutBody.querySelector("#hlSize");
    const sv= flyoutBody.querySelector("#hlSizeVal");
    c.value = state.hl.color; s.value = state.hl.size; sv.textContent = s.value;
    c.oninput = ()=> state.hl.color = c.value;
    s.oninput = ()=>{ state.hl.size = +s.value; sv.textContent = s.value; };
  }
  if(kind==="eraser"){
    const r = flyoutBody.querySelector("#eraserRadius");
    const rv= flyoutBody.querySelector("#eraserRadiusVal");
    r.value = state.eraser.radius; rv.textContent = r.value;
    r.oninput = ()=>{ state.eraser.radius = +r.value; rv.textContent = r.value; };
  }
}

/* ===== ä¿å­˜/èª­è¾¼/å‡ºåŠ›/å…±æœ‰ ===== */
document.getElementById("btnSave").addEventListener("click", ()=>{
  const data = JSON.stringify({ pages: state.pages }, null, 2);
  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([data], {type:"application/json"}));
  a.download = "note-link.json";
  a.click();
});
const fileLoad = document.getElementById("fileLoad");
document.getElementById("btnLoad").addEventListener("click", ()=> fileLoad.click());
fileLoad.addEventListener("change", (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const fr = new FileReader();
  fr.onload = ()=>{
    try{
      const j = JSON.parse(fr.result);
      if(Array.isArray(j.pages)){ state.pages = j.pages; state.pageIndex = 0; render(); }
    }catch(err){ alert("JSONã®å½¢å¼ãŒä¸æ­£ã§ã™"); }
  };
  fr.readAsText(f); e.target.value = "";
});
document.getElementById("btnExport").addEventListener("click", ()=>{
  const a = document.createElement("a");
  a.href = canvas.toDataURL("image/png");
  a.download = "note-page.png";
  a.click();
});
const shareModal = document.getElementById("shareModal");
document.getElementById("btnShare").addEventListener("click", ()=> shareModal.classList.add("open"));
document.getElementById("btnCloseShare").addEventListener("click", ()=> shareModal.classList.remove("open"));
document.getElementById("btnCopySteps").addEventListener("click", async ()=>{
  const txt = [
    "ã€Note Link å…±æœ‰æ‰‹é †ã€‘",
    "1) ä¿å­˜(JSON)ã§ note-link.json ã‚’ä¿å­˜",
    "2) Googleãƒ‰ãƒ©ã‚¤ãƒ–ã«ã‚¢ãƒƒãƒ—ã—ã¦å…±æœ‰ãƒªãƒ³ã‚¯ã‚’ä½œæˆ",
    "3) å…ˆç”Ÿã¸ãƒªãƒ³ã‚¯æå‡ºï¼ˆãƒ¡ãƒ¼ãƒ«/LINE/ãƒ•ã‚©ãƒ¼ãƒ ï¼‰"
  ].join("\n");
  try{ await navigator.clipboard.writeText(txt); alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"); }catch{ alert("ã‚³ãƒ”ãƒ¼ã§ãã¾ã›ã‚“ã§ã—ãŸ"); }
});

/* ===== æ•™å¸«ãƒ¢ãƒ¼ãƒ‰ï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ï¼‰ ===== */
const btnToggleMode = document.getElementById("btnToggleMode");
btnToggleMode.addEventListener("click", ()=>{
  state.mode = (state.mode === "student") ? "teacher" : "student";
  modeBadge.textContent = (state.mode === "teacher") ? "æ•™å¸«ãƒ¢ãƒ¼ãƒ‰(é–²è¦§å°‚ç”¨)" : "ç”Ÿå¾’ãƒ¢ãƒ¼ãƒ‰";
  btnToggleMode.textContent = (state.mode === "teacher") ? "ç”Ÿå¾’ãƒ¢ãƒ¼ãƒ‰" : "æ•™å¸«ãƒ¢ãƒ¼ãƒ‰";
});

/* ===== å…¥åŠ›ï¼ˆæç”»/ç§»å‹•/ãƒ†ã‚­ã‚¹ãƒˆï¼‰ ===== */
function page(){ return state.pages[state.pageIndex]; }
function toCanvas(clientX, clientY){
  const r = canvas.getBoundingClientRect();
  return { x:(clientX - r.left - state.view.x)/state.view.scale, y:(clientY - r.top - state.view.y)/state.view.scale };
}
canvas.addEventListener("pointerdown", (e)=>{
  if(state.mode === "teacher") return; // æ•™å¸«ãƒ¢ãƒ¼ãƒ‰ã¯ç·¨é›†ä¸å¯
  if(state.tool === "text"){
    const p = toCanvas(e.clientX, e.clientY);
    textInput.style.left = (e.clientX - 6)+"px";
    textInput.style.top  = (e.clientY - 10)+"px";
    textInput.style.display = "block";
    textInput.value = ""; textInput.focus();
    const confirm = ()=>{
      const v = textInput.value.trim();
      textInput.style.display = "none";
      textInput.onblur = textInput.onkeydown = null;
      if(v){ page().texts.push({text:v, x:p.x, y:p.y, color:"#ffffff", size:18}); render(); }
    };
    textInput.onkeydown = (ev)=>{ if(ev.key==="Enter"){ ev.preventDefault(); confirm(); } if(ev.key==="Escape"){ ev.preventDefault(); textInput.style.display="none"; } };
    textInput.onblur = confirm;
    return;
  }
  state.drawing = true;
  const p = toCanvas(e.clientX, e.clientY);
  if(state.tool === "pen"){
    state.stroke = { tool:"pen", color:state.pen.color, size:state.pen.size, alpha:state.pen.alpha, points:[p] };
  }else if(state.tool === "hl"){
    state.stroke = { tool:"hl", color:state.hl.color, size:state.hl.size, alpha:state.hl.alpha, points:[p] };
  }else if(state.tool === "eraser"){
    eraseAt(p.x, p.y, state.eraser.radius);
  }else if(state.tool === "pan"){
    state.panPrev = {x:e.clientX, y:e.clientY};
  }
  canvas.setPointerCapture(e.pointerId);
  render();
});
canvas.addEventListener("pointermove",(e)=>{
  if(!state.drawing) return;
  const p = toCanvas(e.clientX, e.clientY);
  if(state.tool==="pen"||state.tool==="hl"){ state.stroke.points.push(p); }
  else if(state.tool==="eraser"){ eraseAt(p.x,p.y,state.eraser.radius); }
  else if(state.tool==="pan"){ const dx=e.clientX-state.panPrev.x, dy=e.clientY-state.panPrev.y; state.view.x+=dx; state.view.y+=dy; state.panPrev={x:e.clientX,y:e.clientY}; }
  render();
});
function finish(){
  if(state.stroke){ page().strokes.push(state.stroke); state.stroke=null; }
  state.drawing=false; render();
}
canvas.addEventListener("pointerup", finish);
canvas.addEventListener("pointercancel", finish);

function eraseAt(x,y,r){
  const rr = r*r;
  const pg = page();
  pg.strokes = pg.strokes.filter(s=> !s.points.some(pt=>{ const dx=pt.x-x, dy=pt.y-y; return dx*dx+dy*dy<=rr; }) );
}

/* ===== Undo/Redoï¼ˆè¶…ç°¡æ˜“ï¼‰ ===== */
const undoStack=[]; const redoStack=[];
function snapshot(){ undoStack.push(JSON.stringify(state.pages)); redoStack.length=0; }
document.getElementById("btnUndo").addEventListener("click", ()=>{
  const cur = JSON.stringify(state.pages);
  const prev = undoStack.pop(); if(!prev) return;
  redoStack.push(cur); state.pages = JSON.parse(prev); render();
});
document.getElementById("btnRedo").addEventListener("click", ()=>{
  const cur = JSON.stringify(state.pages);
  const next = redoStack.pop(); if(!next) return;
  undoStack.push(cur); state.pages = JSON.parse(next); render();
});

/* ===== æç”» ===== */
function render(){
  const r = canvas.getBoundingClientRect(), w=r.width, h=r.height;
  ctx.clearRect(0,0,w,h);
  ctx.save();
  ctx.translate(state.view.x, state.view.y);
  ctx.scale(state.view.scale, state.view.scale);

  const pg = page();
  // strokes
  ctx.lineCap = "round"; ctx.lineJoin="round";
  for(const s of pg.strokes){
    ctx.globalAlpha = s.alpha; ctx.strokeStyle = s.color; ctx.lineWidth = s.size;
    ctx.beginPath(); ctx.moveTo(s.points[0].x, s.points[0].y);
    for(let i=1;i<s.points.length;i++){ const p=s.points[i]; ctx.lineTo(p.x,p.y); }
    ctx.stroke(); ctx.globalAlpha = 1;
  }
  if(state.stroke){
    const s = state.stroke; ctx.globalAlpha=s.alpha; ctx.strokeStyle=s.color; ctx.lineWidth=s.size;
    ctx.beginPath(); ctx.moveTo(s.points[0].x, s.points[0].y);
    for(let i=1;i<s.points.length;i++){ const p=s.points[i]; ctx.lineTo(p.x,p.y); }
    ctx.stroke(); ctx.globalAlpha = 1;
  }
  // texts
  for(const t of pg.texts){
    ctx.font = `${t.size||18}px 'Noto Sans JP',sans-serif`;
    ctx.fillStyle = t.color||"#fff"; ctx.textBaseline="top";
    ctx.fillText(t.text, t.x, t.y);
  }

  ctx.restore();
}

function init(){
  resizeCanvas();
  // åˆå›ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ
  snapshot();
}
window.addEventListener("load", init);
</script>
</body>
</html>
